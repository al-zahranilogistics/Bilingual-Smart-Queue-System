<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="screen-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    <title>العراقي للخدمات اللوجستية - نظام الطابور الذكي</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        /* === TV Display Optimizations === */
        :root {
            --tv-width: 1920px;
            --tv-height: 1080px;
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --accent-teal: #06b6d4;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        /* TV Mode Container */
        .tv-container {
            width: 100vw;
            height: 56.25vw; /* 16:9 Aspect Ratio */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 Aspect Ratio */
            margin: 0 auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }
        
        /* Portrait Mode Fix */
        @media (orientation: portrait) {
            .tv-container {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
            }
        }
        
        /* Small Screens */
        @media (max-width: 768px) {
            .tv-container {
                width: 100vw;
                height: 100vh;
            }
        }
        
        /* Text Direction */
        .arabic { 
            font-family: 'Cairo', sans-serif; 
            direction: rtl;
        }
        
        .english { 
            font-family: 'Inter', sans-serif; 
            direction: ltr;
        }
        
        /* === Display Optimizations === */
        .display-current-call {
            font-size: 20vw;
            font-weight: 900;
            text-shadow: 
                0 0 30px rgba(59, 130, 246, 0.8),
                0 0 60px rgba(59, 130, 246, 0.6),
                0 0 90px rgba(59, 130, 246, 0.4);
        }
        
        .display-department-name {
            font-size: 4vw;
            font-weight: 700;
        }
        
        .display-room-name {
            font-size: 3vw;
            font-weight: 600;
        }
        
        .display-ticket-number {
            font-size: 8vw;
            font-weight: 900;
        }
        
        .display-ticket-department {
            font-size: 2.5vw;
        }
        
        .display-ticket-office {
            font-size: 2vw;
        }
        
        @media (min-width: 1920px) {
            .display-current-call {
                font-size: 380px;
            }
            
            .display-department-name {
                font-size: 76px;
            }
            
            .display-room-name {
                font-size: 57px;
            }
            
            .display-ticket-number {
                font-size: 150px;
            }
            
            .display-ticket-department {
                font-size: 48px;
            }
            
            .display-ticket-office {
                font-size: 38px;
            }
        }
        
        /* Animations */
        @keyframes neonPulse {
            0% { 
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.4),
                          0 0 20px rgba(59, 130, 246, 0.3),
                          0 0 30px rgba(59, 130, 246, 0.2);
            }
            100% { 
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.6),
                          0 0 30px rgba(59, 130, 246, 0.4),
                          0 0 45px rgba(59, 130, 246, 0.3);
            }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        @keyframes soundPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .neon-pulse {
            animation: neonPulse 2s infinite alternate;
        }
        
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.5s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.5s ease-out; }
        .animate-marquee { animation: marquee 30s linear infinite; }
        .sound-pulse { animation: soundPulse 1.5s infinite; }
        
        /* Sound Indicator */
        .sound-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 2px solid rgba(34, 197, 94, 0.3);
        }
        
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Card Styles */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }
        
        /* Ticket Cards */
        .waiting-ticket-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            border: 3px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .approved-ticket-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(21, 128, 61, 0.85) 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            border: 3px solid rgba(34, 197, 94, 0.5);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: bold;
            border: none;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-green), #34d399);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-red), #f87171);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            transition: all 0.3s ease;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(203, 213, 225, 0.8);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.9);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Logo */
        .logo-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-container img {
            width: 85%;
            height: 85%;
            object-fit: contain;
        }
        
        /* Ticker */
        .ticker-container {
            background: linear-gradient(90deg, 
                rgba(30, 64, 175, 0.9) 0%,
                rgba(59, 130, 246, 0.9) 50%,
                rgba(30, 64, 175, 0.9) 100%);
            padding: 20px 0;
            overflow: hidden;
            position: relative;
        }
        
        /* Display Layout */
        .display-left-panel {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .display-right-panel {
            width: 45%;
            padding: 40px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border-left: 3px solid rgba(59, 130, 246, 0.4);
            overflow-y: auto;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .display-right-panel {
                width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .display-left-panel,
            .display-right-panel {
                width: 100%;
                padding: 20px;
            }
            
            .display-right-panel {
                border-left: none;
                border-top: 3px solid rgba(59, 130, 246, 0.4);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyA2WwSnB54y4Xf3p_WPFHeSf7QOGgi3rS8",
            authDomain: "zahrani-4bbf3.firebaseapp.com",
            databaseURL: "https://zahrani-4bbf3-default-rtdb.firebaseio.com",
            projectId: "zahrani-4bbf3",
            storageBucket: "zahrani-4bbf3.firebasestorage.app",
            messagingSenderId: "76127187270",
            appId: "1:76127187270:web:c0d8869fc61275da5ab547"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.log("Firebase already initialized:", error);
        }

        const db = firebase.firestore();
        const realtimeDB = firebase.database();
        const auth = firebase.auth();

        // === Enhanced Sound System ===
        class SoundManager {
            constructor() {
                this.speechSynthesis = window.speechSynthesis;
                this.isSpeaking = false;
                this.voices = [];
                this.loadVoices();
            }

            loadVoices() {
                if (this.speechSynthesis) {
                    // Try to get voices
                    const getVoices = () => {
                        this.voices = this.speechSynthesis.getVoices();
                        console.log('Available voices:', this.voices.map(v => `${v.name} (${v.lang})`));
                    };
                    
                    getVoices();
                    this.speechSynthesis.onvoiceschanged = getVoices;
                }
            }

            speak(text, lang = 'ar-SA') {
                if (!this.speechSynthesis) {
                    console.warn('Speech synthesis not supported');
                    return null;
                }

                // Cancel any ongoing speech
                this.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                
                // Configure voice settings
                if (lang.startsWith('ar')) {
                    utterance.rate = 0.85; // Slightly slower for Arabic
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // Find Arabic voice
                    const arabicVoice = this.voices.find(voice => 
                        voice.lang.startsWith('ar') || 
                        voice.name.toLowerCase().includes('arabic')
                    );
                    if (arabicVoice) {
                        utterance.voice = arabicVoice;
                        console.log('Using Arabic voice:', arabicVoice.name);
                    }
                } else {
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // Find English voice
                    const englishVoice = this.voices.find(voice => 
                        voice.lang.startsWith('en') || 
                        voice.name.toLowerCase().includes('english')
                    );
                    if (englishVoice) {
                        utterance.voice = englishVoice;
                        console.log('Using English voice:', englishVoice.name);
                    }
                }
                
                // Speak the announcement
                this.speechSynthesis.speak(utterance);
                this.isSpeaking = true;
                
                utterance.onend = () => {
                    this.isSpeaking = false;
                };
                
                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    this.isSpeaking = false;
                };
                
                return utterance;
            }

            announceTicket(ticketNumber, roomAr, roomEn) {
                const arabicText = `التذكرة رقم ${ticketNumber}، يرجى التوجه إلى ${roomAr}`;
                const englishText = `Ticket number ${ticketNumber}, please proceed to ${roomEn}`;
                
                // Speak Arabic first
                const arUtterance = this.speak(arabicText, 'ar-SA');
                
                if (arUtterance) {
                    arUtterance.onend = () => {
                        // Wait 1 second then speak English
                        setTimeout(() => {
                            this.speak(englishText, 'en-US');
                        }, 1000);
                    };
                }
                
                return true;
            }

            stop() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.cancel();
                    this.isSpeaking = false;
                }
            }
        }

        // Initialize sound manager
        const soundManager = new SoundManager();

        // === System Configuration ===
        const CONFIG = {
            companyName: {
                ar: "العراقي للخدمات اللوجستية",
                en: "Al-Iraqi Logistics Services"
            },
            systemName: {
                ar: "نظام إدارة الطوابير الذكي",
                en: "Smart Queue Management System"
            },
            adminCode: "0906212",
            maxTicketNumber: 10000,
            syncInterval: 2000,
            departments: [
                { 
                    id: 'vehicles', 
                    nameAr: "قسم المركبات", 
                    nameEn: "Vehicles Department",
                    prefix: "V", 
                    roomAr: "مكتب المركبات", 
                    roomEn: "Vehicles Office", 
                    color: "#3b82f6",
                    icon: "fa-solid fa-truck",
                    iconColor: "#1d4ed8",
                    categoryAr: "تعديل المركبات",
                    categoryEn: "Vehicle Modification"
                },
                { 
                    id: 'finance', 
                    nameAr: "قسم المالية", 
                    nameEn: "Finance Department",
                    prefix: "F", 
                    roomAr: "مكتب المدير المالي", 
                    roomEn: "Finance Office", 
                    color: "#10b981",
                    icon: "fa-solid fa-money-bill-wave",
                    iconColor: "#047857",
                    categoryAr: "إدارة المالية",
                    categoryEn: "Financial Management"
                },
                { 
                    id: 'supervisors', 
                    nameAr: "مدير التشغيل", 
                    nameEn: "Supervisors Department",
                    prefix: "S", 
                    roomAr: "مكتب مدير التشغيل", 
                    roomEn: "Supervisors Office", 
                    color: "#8b5cf6",
                    icon: "fa-solid fa-user-tie",
                    iconColor: "#7c3aed",
                    categoryAr: "إدارة العمليات",
                    categoryEn: "Operations Management"
                },
                { 
                    id: 'ninja_sup', 
                    nameAr: "مشرف نينجا", 
                    nameEn: "Ninja Supervisor",
                    prefix: "NS", 
                    roomAr: "مكتب مشرف نينجا", 
                    roomEn: "Ninja Supervisor Office", 
                    color: "#ec4899",
                    icon: "fa-solid fa-user-ninja",
                    iconColor: "#be185d",
                    categoryAr: "إدارة المشاريع",
                    categoryEn: "Project Management"
                },
                { 
                    id: 'kmart_ninja', 
                    nameAr: "مشرف كيمارت", 
                    nameEn: "K-Mart Department",
                    prefix: "K", 
                    roomAr: "مكتب كيمارت", 
                    roomEn: "K-Mart Office", 
                    color: "#f59e0b",
                    icon: "fa-solid fa-store",
                    iconColor: "#d97706",
                    categoryAr: "إدارة المخازن",
                    categoryEn: "Warehouse Management"
                },
                { 
                    id: 'hr', 
                    nameAr: "الموارد البشرية", 
                    nameEn: "Human Resources",
                    prefix: "HR", 
                    roomAr: "مكتب الموارد البشرية", 
                    roomEn: "HR Office", 
                    color: "#ef4444",
                    icon: "fa-solid fa-users",
                    iconColor: "#dc2626",
                    categoryAr: "إدارة الموارد البشرية",
                    categoryEn: "Human Resources Management"
                },
                { 
                    id: 'petroleum', 
                    nameAr: "قسم البترول", 
                    nameEn: "Petroleum Department",
                    prefix: "P", 
                    roomAr: "مكتب البترول", 
                    roomEn: "Petroleum Office", 
                    color: "#06b6d4",
                    icon: "fa-solid fa-gas-pump",
                    iconColor: "#0891b2",
                    categoryAr: "إدارة البترول",
                    categoryEn: "Petroleum Management"
                },
                { 
                    id: 'naqel_mgr', 
                    nameAr: "مدير تشغيل فلو و ناقل", 
                    nameEn: "Naqel Project",
                    prefix: "ON", 
                    roomAr: "مكتب مدير التشغيل", 
                    roomEn: "Naqel Project Office", 
                    color: "#8b5cf6",
                    icon: "fa-solid fa-truck-fast",
                    iconColor: "#7c3aed",
                    categoryAr: "إدارة النقل",
                    categoryEn: "Transport Management"
                },
                { 
                    id: 'ninja_mgr', 
                    nameAr: "مشروع نينجا", 
                    nameEn: "Ninja Project",
                    prefix: "PN", 
                    roomAr: "مكتب مشروع نينجا", 
                    roomEn: "Ninja Project Office", 
                    color: "#6366f1",
                    icon: "fa-solid fa-bolt",
                    iconColor: "#4f46e5",
                    categoryAr: "إدارة المشاريع",
                    categoryEn: "Project Management"
                }
            ]
        };

        // === Language Data ===
        const LANGUAGES = {
            ar: {
                welcome: "مرحباً بكم في شركة العراقي للخدمات اللوجستية",
                selectDept: "اختر القسم المناسب لخدمتكم",
                instructions: "تعليمات الاستخدام",
                instruction1: "اختر القسم المناسب لخدمتك",
                instruction2: "احفظ رقم التذكرة المعروض",
                instruction3: "اجلس في منطقة الانتظار",
                instruction4: "انتظر حتى ظهور رقمك على الشاشة",
                instruction5: "توجه إلى المكتب المحدد عند النداء",
                lastNumber: "آخر رقم",
                waiting: "في الانتظار",
                currentCall: "النداء الحالي",
                waitingService: "بانتظار الخدمة...",
                pleaseWait: "يرجى الجلوس والمتابعة",
                recentCalls: "السجل الحالي",
                ticketGenerated: "تم استخراج تذكرتك!",
                waitForCall: "يرجى الانتظار حتى نداء رقمك",
                employeeLogin: "دخول الموظفين",
                enterCode: "أدخل كود الدخول",
                controlPanel: "لوحة تحكم الموظفين",
                selectDeptControl: "اختر القسم للتحكم في التذاكر",
                waitingList: "قائمة الانتظار",
                calledTickets: "المنداء عليهم",
                recall: "إعادة نداء",
                finish: "إنهاء",
                call: "نداء",
                goBack: "العودة",
                returnToKiosk: "العودة للكشك",
                openDisplay: "فتح شاشة العرض",
                welcomeMessage: "شركة العراقي للخدمات اللوجستية ترحب بكم .. يرجى الانتظار حتى ظهور رقم تذكرتكم",
                systemMessage: "نظام إدارة الطابور الذكي ٢٠٢٥",
                holdTicket: "يرجى الاحتفاظ برقم التذكرة والمتابعة",
                allRights: "جميع الحقوق محفوظة",
                techSupport: "رقم الدعم الفني",
                visitorKiosk: "كشك الزوار",
                adminPanel: "لوحة التحكم",
                displayScreen: "شاشة العرض",
                onlineAppointment: "حجز موعد أونلاين",
                bookAppointment: "حجز موعد",
                selectDate: "اختر التاريخ",
                selectTime: "اختر الوقت",
                name: "الاسم",
                phone: "رقم الهاتف",
                bookNow: "احجز الآن",
                appointmentBooked: "تم حجز الموعد بنجاح",
                appointmentInfo: "معلومات الحجز",
                appointmentDate: "تاريخ الموعد",
                appointmentTime: "وقت الموعد",
                appointmentNumber: "رقم الموعد",
                close: "إغلاق",
                cancel: "إلغاء",
                today: "اليوم",
                tomorrow: "غداً",
                noAppointments: "لا توجد مواعيد",
                appointments: "المواعيد",
                walkIn: "حجز مباشر",
                online: "أونلاين",
                syncStatus: "حالة المزامنة",
                synced: "مزامن",
                syncing: "جارٍ المزامنة...",
                syncError: "خطأ في المزامنة",
                currentView: "العرض الحالي",
                visitorView: "واجهة الزوار",
                displayView: "شاشة العرض",
                adminView: "لوحة التحكم",
                appointmentsList: "قائمة المواعيد",
                nextAppointments: "المواعيد القادمة",
                totalAppointments: "إجمالي المواعيد",
                todayAppointments: "مواعيد اليوم",
                generatingTicket: "جارٍ توليد التذكرة...",
                connectionStatus: "حالة الاتصال",
                connected: "متصل",
                disconnected: "غير متصل",
                reconnect: "إعادة الاتصال",
                ticketNumber: "رقم التذكرة",
                department: "القسم",
                generateTicket: "توليد تذكرة",
                waitingForService: "بانتظار الخدمة",
                proceedTo: "توجه إلى",
                soundAnnouncement: "جاري النداء",
                soundAnnouncementAr: "جاري النداء باللغة العربية",
                soundAnnouncementEn: "جاري النداء باللغة الإنجليزية",
                waitingTickets: "التذاكر المنتظرة",
                approvedTickets: "التذاكر المعتمدة",
                ticketStatus: "حالة التذكرة",
                category: "التصنيف",
                office: "المكتب",
                ticketQueue: "طابور التذاكر",
                nextTicket: "التذكرة التالية",
                yourTurn: "دورك الآن",
                pleaseProceed: "يرجى التوجه إلى",
                systemReady: "النظام جاهز للخدمة",
                waitingForApproval: "بانتظار الموافقة",
                approved: "معتمد",
                inProgress: "قيد التنفيذ",
                processing: "قيد المعالجة"
            },
            en: {
                welcome: "Welcome to Al-Iraqi Logistics Services",
                selectDept: "Select the appropriate department",
                instructions: "Usage Instructions",
                instruction1: "Select the appropriate department",
                instruction2: "Save the displayed ticket number",
                instruction3: "Sit in the waiting area",
                instruction4: "Wait for your number to appear on screen",
                instruction5: "Proceed to the specified office when called",
                lastNumber: "Last Number",
                waiting: "Waiting",
                currentCall: "Current Call",
                waitingService: "Waiting for service...",
                pleaseWait: "Please sit and follow up",
                recentCalls: "Recent Calls",
                ticketGenerated: "Your ticket has been generated!",
                waitForCall: "Please wait for your number to be called",
                employeeLogin: "Employee Login",
                enterCode: "Enter access code",
                controlPanel: "Employee Control Panel",
                selectDeptControl: "Select department to control tickets",
                waitingList: "Waiting List",
                calledTickets: "Called Tickets",
                recall: "Recall",
                finish: "Finish",
                call: "Call",
                goBack: "Go Back",
                returnToKiosk: "Return to Kiosk",
                openDisplay: "Open Display Screen",
                welcomeMessage: "Al-Iraqi Logistics Services welcomes you",
                systemMessage: "Smart Queue Management System 2025",
                holdTicket: "Please keep your ticket number",
                allRights: "All rights reserved",
                techSupport: "Technical Support",
                visitorKiosk: "Visitor Kiosk",
                adminPanel: "Control Panel",
                displayScreen: "Display Screen",
                onlineAppointment: "Online Appointment",
                bookAppointment: "Book Appointment",
                selectDate: "Select Date",
                selectTime: "Select Time",
                name: "Name",
                phone: "Phone Number",
                bookNow: "Book Now",
                appointmentBooked: "Appointment Booked Successfully",
                appointmentInfo: "Appointment Information",
                appointmentDate: "Appointment Date",
                appointmentTime: "Appointment Time",
                appointmentNumber: "Appointment Number",
                close: "Close",
                cancel: "Cancel",
                today: "Today",
                tomorrow: "Tomorrow",
                noAppointments: "No Appointments",
                appointments: "Appointments",
                walkIn: "Walk-in",
                online: "Online",
                syncStatus: "Sync Status",
                synced: "Synced",
                syncing: "Syncing...",
                syncError: "Sync Error",
                currentView: "Current View",
                visitorView: "Visitor Interface",
                displayView: "Display Screen",
                adminView: "Control Panel",
                appointmentsList: "Appointments List",
                nextAppointments: "Upcoming Appointments",
                totalAppointments: "Total Appointments",
                todayAppointments: "Today's Appointments",
                generatingTicket: "Generating ticket...",
                connectionStatus: "Connection Status",
                connected: "Connected",
                disconnected: "Disconnected",
                reconnect: "Reconnect",
                ticketNumber: "Ticket Number",
                department: "Department",
                generateTicket: "Generate Ticket",
                waitingForService: "Waiting for service",
                proceedTo: "Proceed to",
                soundAnnouncement: "Announcement in progress",
                soundAnnouncementAr: "Arabic announcement in progress",
                soundAnnouncementEn: "English announcement in progress",
                waitingTickets: "Waiting Tickets",
                approvedTickets: "Approved Tickets",
                ticketStatus: "Ticket Status",
                category: "Category",
                office: "Office",
                ticketQueue: "Ticket Queue",
                nextTicket: "Next Ticket",
                yourTurn: "Your Turn Now",
                pleaseProceed: "Please proceed to",
                systemReady: "System Ready for Service",
                waitingForApproval: "Waiting for Approval",
                approved: "Approved",
                inProgress: "In Progress",
                processing: "Processing"
            }
        };

        // === Firebase Queue Manager ===
        class FirebaseQueueManager {
            static async initializeDepartmentCounters() {
                try {
                    for (const dept of CONFIG.departments) {
                        const counterRef = db.collection('counters').doc(dept.id);
                        const doc = await counterRef.get();
                        
                        if (!doc.exists) {
                            await counterRef.set({
                                lastNumber: 0,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('Error initializing counters:', error);
                    return false;
                }
            }

            static async getNextTicketNumber(deptId) {
                try {
                    const counterRef = db.collection('counters').doc(deptId);
                    
                    const result = await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let newNumber = 1;
                        
                        if (counterDoc.exists) {
                            const data = counterDoc.data();
                            newNumber = (data.lastNumber || 0) + 1;
                            if (newNumber > CONFIG.maxTicketNumber) {
                                newNumber = 1;
                            }
                        }
                        
                        transaction.set(counterRef, {
                            lastNumber: newNumber,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        return newNumber;
                    });
                    
                    return result.toString();
                } catch (error) {
                    console.error('Error getting ticket number:', error);
                    throw error;
                }
            }

            static async addTicket(ticketData) {
                try {
                    const dept = CONFIG.departments.find(d => d.id === ticketData.deptId);
                    if (!dept) throw new Error('Department not found');
                    
                    const ticketNumber = await this.getNextTicketNumber(ticketData.deptId);
                    
                    const ticket = {
                        ...ticketData,
                        id: `ticket_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        number: ticketNumber,
                        deptPrefix: dept.prefix,
                        displayText: ticketNumber,
                        status: 'waiting',
                        approved: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        departmentNameAr: dept.nameAr,
                        departmentNameEn: dept.nameEn,
                        roomAr: dept.roomAr,
                        roomEn: dept.roomEn,
                        categoryAr: dept.categoryAr,
                        categoryEn: dept.categoryEn
                    };
                    
                    await db.collection('tickets').doc(ticket.id).set(ticket);
                    
                    return ticket;
                } catch (error) {
                    console.error('Error adding ticket:', error);
                    throw error;
                }
            }

            static async callTicket(ticketId) {
                try {
                    const ticketRef = db.collection('tickets').doc(ticketId);
                    const ticketDoc = await ticketRef.get();
                    
                    if (!ticketDoc.exists) {
                        throw new Error('Ticket not found');
                    }
                    
                    const ticket = ticketDoc.data();
                    const dept = CONFIG.departments.find(d => d.id === ticket.deptId);
                    
                    await ticketRef.update({
                        status: 'called',
                        calledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await realtimeDB.ref(`currentCalls/${ticket.deptId}`).set({
                        ticketId: ticket.id,
                        ticketNumber: ticket.number,
                        calledAt: Date.now(),
                        departmentNameAr: dept.nameAr,
                        departmentNameEn: dept.nameEn,
                        roomAr: dept.roomAr,
                        roomEn: dept.roomEn,
                        categoryAr: dept.categoryAr,
                        categoryEn: dept.categoryEn
                    });
                    
                    return ticket;
                } catch (error) {
                    console.error('Error calling ticket:', error);
                    throw error;
                }
            }

            static async approveTicket(ticketId) {
                try {
                    await db.collection('tickets').doc(ticketId).update({
                        approved: true,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error approving ticket:', error);
                    throw error;
                }
            }

            static async finishTicket(ticketId) {
                try {
                    await db.collection('tickets').doc(ticketId).update({
                        status: 'finished',
                        finishedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error finishing ticket:', error);
                    throw error;
                }
            }

            static subscribeToTickets(callback) {
                return db.collection('tickets')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .onSnapshot(snapshot => {
                        const tickets = [];
                        snapshot.forEach(doc => {
                            tickets.push({ id: doc.id, ...doc.data() });
                        });
                        callback(tickets);
                    }, error => {
                        console.error('Error subscribing to tickets:', error);
                    });
            }

            static subscribeToCurrentCalls(callback) {
                return realtimeDB.ref('currentCalls').on('value', snapshot => {
                    callback(snapshot.val() || {});
                }, error => {
                    console.error('Error subscribing to current calls:', error);
                });
            }

            static async getDepartmentStats(deptId) {
                try {
                    const waitingQuery = await db.collection('tickets')
                        .where('deptId', '==', deptId)
                        .where('status', '==', 'waiting')
                        .get();
                    
                    const calledQuery = await db.collection('tickets')
                        .where('deptId', '==', deptId)
                        .where('status', '==', 'called')
                        .get();
                    
                    const counterDoc = await db.collection('counters').doc(deptId).get();
                    const lastNumber = counterDoc.exists ? counterDoc.data().lastNumber || 0 : 0;
                    
                    return {
                        waitingCount: waitingQuery.size,
                        calledCount: calledQuery.size,
                        lastNumber: lastNumber
                    };
                } catch (error) {
                    console.error('Error getting department stats:', error);
                    return { waitingCount: 0, calledCount: 0, lastNumber: 0 };
                }
            }

            static async getAllStats() {
                try {
                    const stats = {};
                    for (const dept of CONFIG.departments) {
                        stats[dept.id] = await this.getDepartmentStats(dept.id);
                    }
                    return stats;
                } catch (error) {
                    console.error('Error getting all stats:', error);
                    return {};
                }
            }
        }

        // === Main React Application ===
        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            const [view, setView] = useState('kiosk');
            const [language, setLanguage] = useState('ar');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [tickets, setTickets] = useState([]);
            const [currentCalls, setCurrentCalls] = useState({});
            const [departmentStats, setDepartmentStats] = useState({});
            const [activeDept, setActiveDept] = useState(null);
            const [successTicket, setSuccessTicket] = useState(null);
            const [adminCode, setAdminCode] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [adminError, setAdminError] = useState('');
            const [isGeneratingTicket, setIsGeneratingTicket] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [showSoundIndicator, setShowSoundIndicator] = useState(false);
            const [currentAnnouncementLang, setCurrentAnnouncementLang] = useState('');
            const [isSoundPlaying, setIsSoundPlaying] = useState(false);

            const t = LANGUAGES[language];
            const isRTL = language === 'ar';

            // Initialize Firebase and system
            useEffect(() => {
                const initializeSystem = async () => {
                    try {
                        setConnectionStatus('connecting');
                        await FirebaseQueueManager.initializeDepartmentCounters();
                        
                        const stats = await FirebaseQueueManager.getAllStats();
                        setDepartmentStats(stats);
                        
                        setConnectionStatus('connected');
                        
                        // Test sound system
                        if ('speechSynthesis' in window) {
                            console.log('Speech synthesis available');
                        }
                    } catch (error) {
                        console.error('Initialization error:', error);
                        setConnectionStatus('error');
                    }
                };
                
                initializeSystem();
                
                // Subscribe to real-time updates
                const unsubscribeTickets = FirebaseQueueManager.subscribeToTickets((newTickets) => {
                    setTickets(newTickets);
                });
                
                const unsubscribeCalls = FirebaseQueueManager.subscribeToCurrentCalls((calls) => {
                    setCurrentCalls(calls);
                });
                
                // Update stats periodically
                const statsInterval = setInterval(async () => {
                    const stats = await FirebaseQueueManager.getAllStats();
                    setDepartmentStats(stats);
                }, 10000);
                
                // Update time
                const timeInterval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                
                // Monitor network status
                const handleOnline = () => {
                    setIsOnline(true);
                    setConnectionStatus('connected');
                };
                
                const handleOffline = () => {
                    setIsOnline(false);
                    setConnectionStatus('disconnected');
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Check URL for view parameter
                const urlParams = new URLSearchParams(window.location.search);
                const requestedView = urlParams.get('view');
                
                if (requestedView === 'display') {
                    setView('display');
                } else if (requestedView === 'admin') {
                    setShowAdminLogin(true);
                }
                
                return () => {
                    unsubscribeTickets();
                    unsubscribeCalls();
                    clearInterval(statsInterval);
                    clearInterval(timeInterval);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    soundManager.stop();
                };
            }, []);

            // Handle ticket call with sound
            const handleCallTicketWithSound = async (ticket) => {
                try {
                    const updatedTicket = await FirebaseQueueManager.callTicket(ticket.id);
                    const dept = CONFIG.departments.find(d => d.id === ticket.deptId);
                    
                    // Show sound indicator
                    setShowSoundIndicator(true);
                    setIsSoundPlaying(true);
                    
                    // Play Arabic announcement
                    setCurrentAnnouncementLang('ar');
                    soundManager.announceTicket(
                        updatedTicket.number,
                        dept?.roomAr || updatedTicket.roomAr,
                        dept?.roomEn || updatedTicket.roomEn
                    );
                    
                    // Hide indicator after completion
                    setTimeout(() => {
                        setIsSoundPlaying(false);
                        if (!soundManager.isSpeaking) {
                            setShowSoundIndicator(false);
                        }
                    }, 8000);
                    
                } catch (error) {
                    console.error('Error calling ticket:', error);
                    alert(language === 'ar' ? 'حدث خطأ في نداء التذكرة' : 'Error calling ticket');
                }
            };

            // Generate a new ticket
            const handleGenerateTicket = async (deptId) => {
                if (!isOnline) {
                    alert(language === 'ar' ? 'لا يوجد اتصال بالإنترنت' : 'No internet connection');
                    return;
                }
                
                setIsGeneratingTicket(true);
                try {
                    const ticket = await FirebaseQueueManager.addTicket({
                        deptId,
                        type: 'walk-in',
                        customerName: '',
                        customerPhone: '',
                        notes: ''
                    });
                    
                    setSuccessTicket(ticket);
                    
                    // Update stats
                    const stats = await FirebaseQueueManager.getDepartmentStats(deptId);
                    setDepartmentStats(prev => ({
                        ...prev,
                        [deptId]: stats
                    }));
                    
                    // Auto-hide success message after 5 seconds
                    setTimeout(() => setSuccessTicket(null), 5000);
                    
                } catch (error) {
                    console.error('Error generating ticket:', error);
                    alert(language === 'ar' ? 'حدث خطأ في توليد التذكرة' : 'Error generating ticket');
                } finally {
                    setIsGeneratingTicket(false);
                }
            };

            // Format functions
            const formatTime = (date) => {
                return date.toLocaleTimeString(isRTL ? 'ar-SA' : 'en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            const formatDate = (date) => {
                return date.toLocaleDateString(isRTL ? 'ar-SA' : 'en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            // Get current call for display
            const getCurrentCallForDisplay = () => {
                const calls = Object.values(currentCalls);
                if (calls.length === 0) return null;
                
                const mostRecent = calls.reduce((latest, call) => {
                    return (!latest || call.calledAt > latest.calledAt) ? call : latest;
                }, null);
                
                return mostRecent;
            };

            // Admin login
            const handleAdminLogin = () => {
                if (adminCode === CONFIG.adminCode) {
                    setView('admin');
                    setShowAdminLogin(false);
                    setAdminCode('');
                    setAdminError('');
                } else {
                    setAdminError(isRTL ? 'كود الدخول غير صحيح' : 'Incorrect access code');
                }
            };

            // Render methods
            const renderKioskView = () => (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    <div className="text-center mb-10">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
                            {t.welcome}
                        </h1>
                        <p className="text-gray-600 text-lg">
                            {t.selectDept}
                        </p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
                        {CONFIG.departments.map(dept => {
                            const waitingCount = tickets.filter(t => 
                                t.deptId === dept.id && t.status === 'waiting'
                            ).length;
                            
                            const stats = departmentStats[dept.id] || { lastNumber: 0, waitingCount: 0 };
                            
                            return (
                                <button
                                    key={dept.id}
                                    onClick={() => handleGenerateTicket(dept.id)}
                                    disabled={isGeneratingTicket || !isOnline}
                                    className={`card hover:border-blue-300 text-left transition-all ${isGeneratingTicket ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    <div className="flex flex-col items-center text-center">
                                        <div 
                                            className="w-16 h-16 rounded-xl flex items-center justify-center mb-4"
                                            style={{ backgroundColor: dept.color }}
                                        >
                                            <i className={`${dept.icon} text-2xl text-white`}></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-800 mb-2">
                                            {language === 'ar' ? dept.nameAr : dept.nameEn}
                                        </h3>
                                        <div className="text-sm text-gray-500 mb-3">
                                            {language === 'ar' ? dept.roomAr : dept.roomEn}
                                        </div>
                                        <div className="mt-2">
                                            <div className="text-2xl font-bold text-gray-700">
                                                {stats.lastNumber || 0}
                                            </div>
                                            <div className="text-xs text-gray-500">{t.lastNumber}</div>
                                            {waitingCount > 0 && (
                                                <div className="mt-2 text-sm text-blue-600">
                                                    {waitingCount} {t.waiting}
                                                </div>
                                            )}
                                        </div>
                                        <div className="mt-4">
                                            <button 
                                                className={`btn-primary ${isGeneratingTicket ? 'opacity-50' : ''}`}
                                                disabled={isGeneratingTicket || !isOnline}
                                            >
                                                {isGeneratingTicket ? (
                                                    <>
                                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                                        {t.generatingTicket}
                                                    </>
                                                ) : (
                                                    <>
                                                        <i className="fas fa-ticket-alt mr-2"></i>
                                                        {t.generateTicket}
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="card text-center">
                            <div className="text-3xl font-bold text-blue-600">
                                {tickets.filter(t => t.status === 'waiting').length}
                            </div>
                            <div className="text-gray-600">{t.waitingList}</div>
                        </div>
                        <div className="card text-center">
                            <div className="text-3xl font-bold text-green-600">
                                {tickets.filter(t => t.status === 'called').length}
                            </div>
                            <div className="text-gray-600">{t.calledTickets}</div>
                        </div>
                        <div className="card text-center">
                            <div className="text-3xl font-bold text-purple-600">
                                {tickets.length}
                            </div>
                            <div className="text-gray-600">{t.totalAppointments}</div>
                        </div>
                    </div>
                    
                    <div className="card bg-blue-50 border-blue-100">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i className="fas fa-info-circle text-blue-500"></i>
                            {t.instructions}
                        </h3>
                        <ol className={`space-y-3 text-gray-700 ${isRTL ? 'list-decimal pr-5' : 'list-decimal pl-5'}`}>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-600 font-bold">1.</span>
                                <span>{t.instruction1}</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-600 font-bold">2.</span>
                                <span>{t.instruction2}</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-600 font-bold">3.</span>
                                <span>{t.instruction3}</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-600 font-bold">4.</span>
                                <span>{t.instruction4}</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-600 font-bold">5.</span>
                                <span>{t.instruction5}</span>
                            </li>
                        </ol>
                    </div>
                </div>
            );

            const renderDisplayView = () => {
                const currentCall = getCurrentCallForDisplay();
                
                return (
                    <div className="tv-container">
                        <div className="h-full flex flex-col">
                            {/* Header */}
                            <div className="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-6">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-6">
                                        <div className="logo-container">
                                            <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Iraqi Logo" />
                                        </div>
                                        <div>
                                            <h1 className="text-3xl font-bold arabic">
                                                {CONFIG.companyName.ar}
                                            </h1>
                                            <h1 className="text-2xl font-bold english">
                                                {CONFIG.companyName.en}
                                            </h1>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-4xl font-mono font-bold">
                                            {formatTime(currentTime)}
                                        </div>
                                        <div className="text-lg opacity-80">
                                            {formatDate(currentTime)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Main Display */}
                            <div className="flex-1 flex">
                                {/* Left Panel - Current Call */}
                                <div className="display-left-panel">
                                    <div className="text-center space-y-8">
                                        <div className="text-blue-400 text-3xl font-bold display-department-name">
                                            {t.currentCall}
                                        </div>
                                        
                                        {currentCall ? (
                                            <>
                                                <div className="relative">
                                                    <div className="font-black text-white ticket-glow display-current-call">
                                                        {currentCall.ticketNumber}
                                                    </div>
                                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-20" style={{ fontSize: '40%' }}>
                                                        <i className="fas fa-bullhorn"></i>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-4">
                                                    <div className="font-bold text-blue-300 arabic display-room-name">
                                                        {currentCall.roomAr || "مكتب الخدمة"}
                                                    </div>
                                                    <div className="font-bold text-blue-300 english display-room-name">
                                                        {currentCall.roomEn || "Service Office"}
                                                    </div>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="space-y-8">
                                                <div className="text-[15vw] opacity-30 text-blue-500">
                                                    <i className="fas fa-clock"></i>
                                                </div>
                                                <div className="space-y-4">
                                                    <div className="text-5xl text-gray-400 arabic">{t.systemReady}</div>
                                                    <div className="text-4xl text-gray-400 english">{t.systemReady}</div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Right Panel - Waiting Tickets */}
                                <div className="display-right-panel">
                                    <div className="h-full flex flex-col">
                                        {/* Approved Tickets */}
                                        <div className="mb-8">
                                            <h3 className="text-2xl font-bold text-white mb-4 border-b border-green-500 pb-3 arabic">
                                                <i className="fas fa-check-circle mr-3"></i>
                                                {t.approvedTickets}
                                            </h3>
                                            <div className="space-y-4 overflow-y-auto max-h-64">
                                                {tickets
                                                    .filter(t => t.status === 'waiting' && t.approved === true)
                                                    .slice(0, 3)
                                                    .map((ticket, index) => {
                                                        const dept = CONFIG.departments.find(d => d.id === ticket.deptId);
                                                        return (
                                                            <div 
                                                                key={ticket.id}
                                                                className="approved-ticket-card animate-slide-in-right"
                                                                style={{ animationDelay: `${index * 0.1}s` }}
                                                            >
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="text-white display-ticket-number mb-3">
                                                                            {ticket.number}
                                                                        </div>
                                                                        <div className="arabic text-white display-ticket-department mb-2">
                                                                            {ticket.categoryAr || dept?.categoryAr}
                                                                        </div>
                                                                        <div className="arabic text-gray-200 display-ticket-office">
                                                                            {ticket.roomAr}
                                                                        </div>
                                                                    </div>
                                                                    <div className="bg-white text-green-700 px-4 py-2 rounded-lg font-bold">
                                                                        {t.approved}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                
                                                {tickets.filter(t => t.status === 'waiting' && t.approved === true).length === 0 && (
                                                    <div className="text-center py-6 text-gray-400">
                                                        <i className="fas fa-check-circle text-3xl mb-3"></i>
                                                        <div className="arabic text-xl">{t.noAppointments}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Waiting Tickets */}
                                        <div className="flex-1">
                                            <h3 className="text-2xl font-bold text-white mb-4 border-b border-blue-500 pb-3 arabic">
                                                <i className="fas fa-clock mr-3"></i>
                                                {t.waitingTickets}
                                            </h3>
                                            <div className="space-y-4 overflow-y-auto h-[calc(100%-3rem)]">
                                                {tickets
                                                    .filter(t => t.status === 'waiting' && t.approved !== true)
                                                    .slice(0, 5)
                                                    .map((ticket, index) => {
                                                        const dept = CONFIG.departments.find(d => d.id === ticket.deptId);
                                                        return (
                                                            <div 
                                                                key={ticket.id}
                                                                className="waiting-ticket-card animate-slide-in-left"
                                                                style={{ animationDelay: `${index * 0.1}s` }}
                                                            >
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="text-blue-800 display-ticket-number mb-3">
                                                                            {ticket.number}
                                                                        </div>
                                                                        <div className="arabic text-gray-800 display-ticket-department mb-2">
                                                                            {ticket.categoryAr || dept?.categoryAr}
                                                                        </div>
                                                                        <div className="arabic text-gray-600 display-ticket-office">
                                                                            {ticket.roomAr}
                                                                        </div>
                                                                    </div>
                                                                    <div className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">
                                                                        {ticket.number}
                                                                    </div>
                                                                </div>
                                                                <div className="mt-4 pt-3 border-t border-gray-300">
                                                                    <div className="text-sm text-gray-600 arabic">
                                                                        <i className="fas fa-clock mr-2"></i>
                                                                        {t.waitingForApproval}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                
                                                {tickets.filter(t => t.status === 'waiting' && t.approved !== true).length === 0 && (
                                                    <div className="text-center py-8 text-gray-400">
                                                        <i className="fas fa-clock text-3xl mb-4"></i>
                                                        <div className="arabic text-xl mb-3">{t.noAppointments}</div>
                                                        <div className="text-sm arabic">{t.systemReady}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Ticker */}
                            <div className="ticker-container">
                                <div className="animate-marquee whitespace-nowrap text-2xl font-bold">
                                    <span className="mx-12 arabic">{t.welcomeMessage}</span>
                                    <span className="mx-12 text-yellow-300">●</span>
                                    <span className="mx-12 arabic">{t.systemMessage}</span>
                                    <span className="mx-12 text-yellow-300">●</span>
                                    <span className="mx-12 arabic">{t.holdTicket}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderAdminView = () => (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {!activeDept ? (
                        <div className="space-y-8">
                            <div className="text-center">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                    {t.controlPanel}
                                </h1>
                                <p className="text-gray-600">{t.selectDeptControl}</p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="card text-center">
                                    <div className="text-3xl font-bold text-blue-600">
                                        {tickets.filter(t => t.status === 'waiting').length}
                                    </div>
                                    <div className="text-gray-600">{t.waitingList}</div>
                                    <div className="mt-2 text-sm">
                                        <span className="text-blue-500">{tickets.filter(t => t.type === 'walk-in').length} {t.walkIn}</span>
                                    </div>
                                </div>
                                <div className="card text-center">
                                    <div className="text-3xl font-bold text-green-600">
                                        {tickets.filter(t => t.status === 'called').length}
                                    </div>
                                    <div className="text-gray-600">{t.calledTickets}</div>
                                </div>
                                <div className="card text-center">
                                    <div className="text-3xl font-bold text-purple-600">
                                        {tickets.length}
                                    </div>
                                    <div className="text-gray-600">{t.appointments}</div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {CONFIG.departments.map(dept => {
                                    const waitingCount = tickets.filter(t => 
                                        t.deptId === dept.id && t.status === 'waiting'
                                    ).length;
                                    const stats = departmentStats[dept.id] || { lastNumber: 0 };
                                    
                                    return (
                                        <button
                                            key={dept.id}
                                            onClick={() => setActiveDept(dept.id)}
                                            className="card hover:border-blue-300"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div 
                                                    className="w-14 h-14 rounded-xl flex items-center justify-center"
                                                    style={{ backgroundColor: dept.color }}
                                                >
                                                    <i className={`${dept.icon} text-xl text-white`}></i>
                                                </div>
                                                <div className="text-left flex-1">
                                                    <h3 className="font-bold text-gray-800">
                                                        {language === 'ar' ? dept.nameAr : dept.nameEn}
                                                    </h3>
                                                    <p className="text-sm text-gray-500">
                                                        {language === 'ar' ? dept.roomAr : dept.roomEn}
                                                    </p>
                                                    <div className="mt-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-gray-600">{t.waiting}:</span>
                                                            <span className="text-xl font-bold" style={{ color: dept.color }}>
                                                                {waitingCount}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between items-center mt-1">
                                                            <span className="text-gray-600">{t.lastNumber}:</span>
                                                            <span className="text-lg font-bold">
                                                                {stats.lastNumber || 0}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                            
                            <div className="flex justify-center gap-4">
                                <a
                                    href="?view=kiosk"
                                    className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    {t.returnToKiosk}
                                </a>
                                <a
                                    href="?view=display"
                                    target="_blank"
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                >
                                    {t.openDisplay}
                                </a>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            <div className="card bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={() => setActiveDept(null)}
                                            className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition"
                                        >
                                            <i className="fas fa-arrow-left text-xl"></i>
                                        </button>
                                        <div>
                                            <h2 className="text-2xl font-bold">
                                                {language === 'ar' ? 
                                                    CONFIG.departments.find(d => d.id === activeDept)?.nameAr :
                                                    CONFIG.departments.find(d => d.id === activeDept)?.nameEn}
                                            </h2>
                                            <p className="opacity-90">
                                                {language === 'ar' ? 
                                                    CONFIG.departments.find(d => d.id === activeDept)?.roomAr :
                                                    CONFIG.departments.find(d => d.id === activeDept)?.roomEn}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-3xl font-bold">
                                            {(departmentStats[activeDept]?.lastNumber || 0)}
                                        </div>
                                        <div className="text-sm opacity-80">{t.lastNumber}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="card">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">
                                        {t.waitingList} ({tickets.filter(t => t.deptId === activeDept && t.status === 'waiting').length})
                                    </h3>
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {tickets
                                            .filter(t => t.deptId === activeDept && t.status === 'waiting')
                                            .sort((a, b) => a.createdAt - b.createdAt)
                                            .map(ticket => (
                                                <div key={ticket.id} className="flex justify-between items-center p-4 rounded-lg border bg-gray-50">
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="text-2xl font-bold text-gray-800">
                                                                {ticket.number}
                                                            </div>
                                                            {ticket.approved && (
                                                                <span className="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-sm font-bold">
                                                                    {t.approved}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-1">
                                                            {formatTime(ticket.createdAt?.toDate?.() || new Date(ticket.createdAt))}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {!ticket.approved && (
                                                            <button
                                                                onClick={() => FirebaseQueueManager.approveTicket(ticket.id)}
                                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium"
                                                            >
                                                                <i className="fas fa-check mr-2"></i>
                                                                {t.approved}
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => handleCallTicketWithSound(ticket)}
                                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium"
                                                        >
                                                            <i className="fas fa-bullhorn mr-2"></i>
                                                            {t.call}
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        
                                        {tickets.filter(t => t.deptId === activeDept && t.status === 'waiting').length === 0 && (
                                            <div className="text-center py-4 text-gray-500">
                                                <i className="fas fa-clock text-2xl mb-2"></i>
                                                <div>{language === 'ar' ? 'لا توجد تذاكر في الانتظار' : 'No tickets waiting'}</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="card">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">
                                        {t.calledTickets} ({tickets.filter(t => t.deptId === activeDept && t.status === 'called').length})
                                    </h3>
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {tickets
                                            .filter(t => t.deptId === activeDept && t.status === 'called')
                                            .sort((a, b) => (b.calledAt || 0) - (a.calledAt || 0))
                                            .map(ticket => (
                                                <div key={ticket.id} className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                                                    <div className="text-center mb-4">
                                                        <div className="text-3xl font-bold text-gray-800">
                                                            {ticket.number}
                                                        </div>
                                                        <div className="text-sm text-gray-500">
                                                            {formatTime(ticket.calledAt?.toDate?.() || new Date(ticket.calledAt))}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => handleCallTicketWithSound(ticket)}
                                                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium flex-1"
                                                        >
                                                            <i className="fas fa-redo mr-2"></i>
                                                            {t.recall}
                                                        </button>
                                                        <button
                                                            onClick={() => FirebaseQueueManager.finishTicket(ticket.id)}
                                                            className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium flex-1"
                                                        >
                                                            <i className="fas fa-check mr-2"></i>
                                                            {t.finish}
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        
                                        {tickets.filter(t => t.deptId === activeDept && t.status === 'called').length === 0 && (
                                            <div className="text-center py-4 text-gray-500">
                                                <i className="fas fa-bullhorn text-2xl mb-2"></i>
                                                <div>{language === 'ar' ? 'لا توجد تذاكر مناداة' : 'No tickets called'}</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col" dir={isRTL ? 'rtl' : 'ltr'}>
                    {/* Sound Announcement Indicator */}
                    {showSoundIndicator && (
                        <div className="sound-indicator">
                            <i className={`fas fa-volume-up sound-pulse ${currentAnnouncementLang === 'ar' ? 'text-green-400' : 'text-blue-400'}`}></i>
                            <span className="text-lg font-bold">
                                {currentAnnouncementLang === 'ar' ? t.soundAnnouncementAr : t.soundAnnouncementEn}
                            </span>
                        </div>
                    )}

                    {/* Connection Status Indicator */}
                    <div className={`connection-status ${isOnline ? 'connected' : 'disconnected'}`}>
                        <i className={`fas fa-${isOnline ? 'wifi' : 'wifi-slash'}`}></i>
                        <span>{isOnline ? t.connected : t.disconnected}</span>
                    </div>

                    {/* Admin Login Modal */}
                    {showAdminLogin && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="card max-w-md w-full">
                                <div className="text-center space-y-6">
                                    <div>
                                        <i className="fas fa-lock text-4xl text-blue-500 mb-4"></i>
                                        <h2 className="text-2xl font-bold text-gray-800">{t.employeeLogin}</h2>
                                        <p className="text-gray-600 mt-2">{t.enterCode}</p>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <input
                                            type="password"
                                            value={adminCode}
                                            onChange={(e) => setAdminCode(e.target.value)}
                                            placeholder={isRTL ? "أدخل الكود هنا" : "Enter code here"}
                                            className="w-full p-3 border border-gray-300 rounded-lg text-center text-xl font-mono"
                                            autoFocus
                                            onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                        />
                                        
                                        {adminError && (
                                            <div className="text-red-500 font-medium animate-slide-in">
                                                {adminError}
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={handleAdminLogin}
                                            className="btn-primary w-full"
                                        >
                                            {isRTL ? 'دخول' : 'Login'}
                                        </button>
                                    </div>
                                    
                                    <button
                                        onClick={() => {
                                            setShowAdminLogin(false);
                                            setAdminCode('');
                                            setAdminError('');
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        {isRTL ? 'إلغاء' : 'Cancel'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Success Ticket Modal */}
                    {successTicket && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="card max-w-md w-full bg-gradient-to-br from-blue-50 to-white">
                                <div className="text-center space-y-6">
                                    <div className="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mx-auto">
                                        <i className="fas fa-ticket-alt text-3xl text-blue-500"></i>
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-bold text-gray-800">{t.ticketGenerated}</h3>
                                        <div className="text-6xl font-black text-blue-600 mt-4 tracking-wider">
                                            {successTicket.number}
                                        </div>
                                        <div className="mt-4 space-y-2">
                                            <div className="text-lg font-medium text-gray-700">
                                                {t.department}: {language === 'ar' ? successTicket.departmentNameAr : successTicket.departmentNameEn}
                                            </div>
                                            <div className="text-gray-600">
                                                {t.waitForCall}
                                            </div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setSuccessTicket(null)}
                                        className="btn-primary"
                                    >
                                        {isRTL ? 'تم' : 'OK'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header for all views except display */}
                    {view !== 'display' && (
                        <header className="bg-white shadow-md">
                            <div className="max-w-7xl mx-auto px-4 py-4">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className="logo-container">
                                            <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Iraqi Logo" />
                                        </div>
                                        <div className={isRTL ? 'arabic' : 'english'}>
                                            <h1 className="text-xl font-bold text-gray-800">
                                                {CONFIG.companyName[language]}
                                            </h1>
                                            <p className="text-sm text-blue-600">
                                                {CONFIG.systemName[language]}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="text-center">
                                        <div className="flex items-center gap-2 justify-center mb-1">
                                            <div className={`w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`}></div>
                                            <span className="text-sm text-gray-600">
                                                {isOnline ? t.connected : t.disconnected}
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {tickets.filter(t => t.status === 'waiting').length} {t.waiting}
                                        </div>
                                    </div>
                                    
                                    <div className="flex flex-wrap items-center gap-2">
                                        <button
                                            onClick={() => setLanguage(lang => lang === 'ar' ? 'en' : 'ar')}
                                            className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-2"
                                        >
                                            <span className={`font-medium ${language === 'ar' ? 'text-blue-600' : 'text-gray-600'}`}>
                                                {language === 'ar' ? 'ع' : 'EN'}
                                            </span>
                                            <i className="fas fa-globe text-gray-500"></i>
                                        </button>
                                        
                                        <a
                                            href="?view=kiosk"
                                            className={`px-4 py-2 rounded-lg font-medium transition ${view === 'kiosk' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                        >
                                            <i className="fas fa-user mr-2"></i>
                                            {t.visitorKiosk}
                                        </a>
                                        
                                        <a
                                            href="?view=display"
                                            target="_blank"
                                            className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                        >
                                            <i className="fas fa-tv mr-2"></i>
                                            {t.openDisplay}
                                        </a>
                                        
                                        <button
                                            onClick={() => setShowAdminLogin(true)}
                                            className={`px-4 py-2 rounded-lg font-medium transition ${view === 'admin' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                        >
                                            <i className="fas fa-cog mr-2"></i>
                                            {t.employeeLogin}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                    )}

                    {/* Main Content */}
                    <main className="flex-1">
                        {view === 'kiosk' && renderKioskView()}
                        {view === 'display' && renderDisplayView()}
                        {view === 'admin' && renderAdminView()}
                    </main>

                    {/* Footer */}
                    {view !== 'display' && (
                        <footer className="bg-gray-800 text-white py-6">
                            <div className="max-w-7xl mx-auto px-4">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className="logo-container" style={{ width: '60px', height: '60px' }}>
                                            <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Iraqi Logo" />
                                        </div>
                                        <div>
                                            <div className="font-bold">{CONFIG.companyName[language]}</div>
                                            <div className="text-sm text-gray-400">{CONFIG.systemName[language]}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="text-center text-gray-300">
                                        <div>© 2025 {t.allRights}</div>
                                        <div className="text-sm mt-1">
                                            {t.techSupport}: {CONFIG.adminCode}
                                        </div>
                                    </div>
                                    
                                    <div className="flex flex-wrap gap-4">
                                        <a href="?view=kiosk" className="text-gray-300 hover:text-white">
                                            {t.visitorKiosk}
                                        </a>
                                        <a href="?view=display" target="_blank" className="text-gray-300 hover:text-white">
                                            {t.displayScreen}
                                        </a>
                                        <a href="?view=admin" className="text-gray-300 hover:text-white">
                                            {t.adminPanel}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    )}
                </div>
            );
        }

        // Render the application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
