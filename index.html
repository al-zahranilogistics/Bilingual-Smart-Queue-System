<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Zahrani - Display Screen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        /* TV Horizontal Layout */
        .tv-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #0c1a2d 0%, #162a45 100%);
            position: relative;
        }
        
        /* Left Side - Current Call (70%) */
        .current-call-section {
            flex: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-right: 3px solid #3b82f6;
            background: rgba(15, 23, 42, 0.7);
        }
        
        /* Right Side - Recent Calls (30%) */
        .recent-calls-section {
            flex: 0.3;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 15px;
            overflow-y: auto;
        }
        
        /* Ticket Number - HUGE */
        .ticket-number {
            font-size: 18vw;
            font-weight: 900;
            color: white;
            text-shadow: 
                0 0 40px rgba(59, 130, 246, 0.9),
                0 0 80px rgba(59, 130, 246, 0.7),
                0 0 120px rgba(59, 130, 246, 0.5);
            margin: 20px 0;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 30px rgba(59, 130, 246, 0.7); }
            to { text-shadow: 0 0 50px rgba(59, 130, 246, 0.9); }
        }
        
        /* Department Info */
        .dept-info {
            text-align: center;
            margin-top: 20px;
        }
        
        .dept-name-ar {
            font-size: 3.5vw;
            color: #60a5fa;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .dept-name-en {
            font-size: 2.5vw;
            color: #93c5fd;
            margin-bottom: 15px;
        }
        
        .room-info {
            font-size: 2vw;
            color: #bfdbfe;
            background: rgba(59, 130, 246, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 5px 0;
        }
        
        /* Recent Calls */
        .recent-title {
            font-size: 2vw;
            color: #60a5fa;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
            text-align: center;
        }
        
        .recent-ticket {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-right: 4px solid;
            transition: all 0.3s;
        }
        
        .recent-ticket:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-5px);
        }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.9);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 2px solid #3b82f6;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            background: white;
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .company-name {
            font-size: 1.8vw;
            font-weight: bold;
        }
        
        /* Time Display */
        .time-display {
            text-align: center;
        }
        
        .current-time {
            font-size: 2.5vw;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #10b981;
        }
        
        .current-date {
            font-size: 1.2vw;
            color: #94a3b8;
        }
        
        /* Status */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Ticker */
        .ticker {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            padding: 12px 0;
            overflow: hidden;
        }
        
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 30s linear infinite;
            font-size: 1.3vw;
            padding-left: 100%;
        }
        
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        /* Speaking Indicator */
        .speaking-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(245, 158, 11, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.2vw;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: speakingPulse 1s infinite;
            z-index: 1000;
        }
        
        @keyframes speakingPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* No Calls */
        .no-calls {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
            font-size: 1.5vw;
        }
        
        .no-calls i {
            font-size: 3vw;
            margin-bottom: 15px;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .ticket-number { font-size: 15vw; }
            .dept-name-ar { font-size: 4vw; }
            .dept-name-en { font-size: 3vw; }
            .room-info { font-size: 2.5vw; }
        }
        
        /* Arabic Font */
        .arabic { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .english { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: ltr; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Speaking Indicator -->
    <div id="speakingIndicator" class="speaking-indicator" style="display: none;">
        <i class="fas fa-volume-up"></i>
        <span id="speakingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡...</span>
    </div>

    <div class="tv-container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo" style="height: 50px; width: auto;">
                </div>
                <div>
                    <div class="company-name arabic">Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ©</div>
                    <div class="company-name english">Al-Zahrani Logistics</div>
                </div>
            </div>
            
            <div class="time-display">
                <div id="currentTime" class="current-time">00:00:00</div>
                <div id="currentDate" class="current-date">...</div>
            </div>
            
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="statusText" class="arabic">Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…</span>
            </div>
        </div>

        <!-- Current Call Section -->
        <div class="current-call-section">
            <div id="currentCallContainer" style="text-align: center;">
                <div class="arabic" style="font-size: 2.5vw; color: #60a5fa; margin-bottom: 20px;">
                    Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ
                </div>
                
                <div id="noCurrentCall" class="no-calls">
                    <i class="fas fa-clock"></i>
                    <div class="arabic" style="font-size: 2vw; margin-bottom: 10px;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©...</div>
                    <div class="english" style="font-size: 1.5vw;">Waiting for service...</div>
                </div>
                
                <div id="currentCallDisplay" style="display: none;">
                    <div id="ticketNumber" class="ticket-number">123</div>
                    
                    <div class="dept-info">
                        <div id="deptNameAr" class="dept-name-ar arabic">Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div>
                        <div id="deptNameEn" class="dept-name-en english">Vehicles Department</div>
                        
                        <div class="arabic room-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="roomAr">Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span>
                        </div>
                        <div class="english room-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="roomEn">Vehicles Office</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Calls Section -->
        <div class="recent-calls-section">
            <div class="recent-title arabic">
                <i class="fas fa-history"></i>
                Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ù†Ø¯Ø§Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹
            </div>
            
            <div id="recentCallsList">
                <!-- Recent calls will be added here by JavaScript -->
            </div>
            
            <div id="noRecentCalls" class="no-calls" style="display: none;">
                <i class="fas fa-ticket-alt"></i>
                <div class="arabic">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…Ù†Ø§Ø¯Ø§Ø©</div>
                <div class="english" style="margin-top: 5px;">No tickets called yet</div>
            </div>
        </div>

        <!-- Ticker -->
        <div class="ticker">
            <div class="ticker-content">
                <span class="arabic" style="margin-right: 50px;">ğŸ¢ Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ© ØªØ±Ø­Ø¨ Ø¨ÙƒÙ…</span>
                <span class="arabic" style="margin-right: 50px;">ğŸ« ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø§Ø´Ø©</span>
                <span class="arabic" style="margin-right: 50px;">ğŸ•’ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø¨ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ 2024</span>
                <span class="english" style="margin-right: 50px;">ğŸ¢ Al-Zahrani Logistics welcomes you</span>
                <span class="english" style="margin-right: 50px;">ğŸ« Please keep your ticket number and follow the screen</span>
                <span class="english" style="margin-right: 50px;">ğŸ•’ Smart Queue Management System 2024</span>
            </div>
        </div>
    </div>

    <script>
        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyA2WwSnB54y4Xf3p_WPFHeSf7QOGgi3rS8",
            authDomain: "zahrani-4bbf3.firebasestorage.app",
            databaseURL: "https://zahrani-4bbf3-default-rtdb.firebaseio.com",
            projectId: "zahrani-4bbf3",
            storageBucket: "zahrani-4bbf3.firebasestorage.app",
            messagingSenderId: "76127187270",
            appId: "1:76127187270:web:c0d8869fc61275da5ab547"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const firestore = firebase.firestore();

        // === Departments Configuration ===
        const DEPARTMENTS = {
            vehicles: { 
                nameAr: "Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª", 
                nameEn: "Vehicles Department",
                roomAr: "Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª", 
                roomEn: "Vehicles Office",
                color: "#3b82f6",
                icon: "fa-truck"
            },
            finance: { 
                nameAr: "Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©", 
                nameEn: "Finance Department",
                roomAr: "Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ", 
                roomEn: "Finance Office",
                color: "#10b981",
                icon: "fa-money-bill-wave"
            },
            supervisors: { 
                nameAr: "Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„", 
                nameEn: "Supervisors Department",
                roomAr: "Ù…ÙƒØªØ¨ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„", 
                roomEn: "Supervisors Office",
                color: "#8b5cf6",
                icon: "fa-user-tie"
            },
            ninja_sup: { 
                nameAr: "Ù…Ø´Ø±Ù Ù†ÙŠÙ†Ø¬Ø§", 
                nameEn: "Ninja Supervisor",
                roomAr: "Ù…ÙƒØªØ¨ Ù…Ø´Ø±Ù Ù†ÙŠÙ†Ø¬Ø§", 
                roomEn: "Ninja Supervisor Office",
                color: "#ec4899",
                icon: "fa-user-ninja"
            },
            kmart_ninja: { 
                nameAr: "Ù…Ø´Ø±Ù ÙƒÙŠÙ…Ø§Ø±Øª", 
                nameEn: "K-Mart Department",
                roomAr: "Ù…ÙƒØªØ¨ ÙƒÙŠÙ…Ø§Ø±Øª", 
                roomEn: "K-Mart Office",
                color: "#f59e0b",
                icon: "fa-store"
            },
            hr: { 
                nameAr: "Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©", 
                nameEn: "Human Resources",
                roomAr: "Ù…ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©", 
                roomEn: "HR Office",
                color: "#ef4444",
                icon: "fa-users"
            },
            petroleum: { 
                nameAr: "Ù‚Ø³Ù… Ø§Ù„Ø¨ØªØ±ÙˆÙ„", 
                nameEn: "Petroleum Department",
                roomAr: "Ù…ÙƒØªØ¨ Ø§Ù„Ø¨ØªØ±ÙˆÙ„", 
                roomEn: "Petroleum Office",
                color: "#06b6d4",
                icon: "fa-gas-pump"
            },
            naqel_mgr: { 
                nameAr: "Ù…Ø¯ÙŠØ± ØªØ´ØºÙŠÙ„ Ù†Ø§Ù‚Ù„", 
                nameEn: "Naqel Project",
                roomAr: "Ù…ÙƒØªØ¨ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„", 
                roomEn: "Naqel Project Office",
                color: "#8b5cf6",
                icon: "fa-truck-fast"
            },
            ninja_mgr: { 
                nameAr: "Ù…Ø´Ø±ÙˆØ¹ Ù†ÙŠÙ†Ø¬Ø§", 
                nameEn: "Ninja Project",
                roomAr: "Ù…ÙƒØªØ¨ Ù…Ø´Ø±ÙˆØ¹ Ù†ÙŠÙ†Ø¬Ø§", 
                roomEn: "Ninja Project Office",
                color: "#6366f1",
                icon: "fa-bolt"
            }
        };

        // === Global Variables ===
        let currentCall = null;
        let recentCalls = [];
        let isSpeaking = false;
        let lastAnnouncedTicket = null;
        let lastAnnouncementTime = 0;

        // === Initialize Speech Synthesis ===
        function initSpeechSynthesis() {
            if ('speechSynthesis' in window) {
                console.log("âœ… Speech synthesis is available");
                
                // Try to speak a silent test to initialize
                const testUtterance = new SpeechSynthesisUtterance('');
                testUtterance.volume = 0;
                speechSynthesis.speak(testUtterance);
                speechSynthesis.cancel();
                
                return true;
            } else {
                console.log("âŒ Speech synthesis not supported");
                return false;
            }
        }

        // === Enhanced Speech Announcement ===
        function speakAnnouncement(ticketNumber, roomAr, roomEn, deptNameAr, deptNameEn) {
            if (!('speechSynthesis' in window) || isSpeaking) {
                return;
            }

            // Prevent duplicate announcements within 20 seconds
            const now = Date.now();
            const announcementKey = `${ticketNumber}_${roomAr}`;
            
            if (lastAnnouncedTicket === announcementKey && (now - lastAnnouncementTime) < 20000) {
                console.log("âš ï¸ Skipping duplicate announcement");
                return;
            }

            isSpeaking = true;
            lastAnnouncedTicket = announcementKey;
            lastAnnouncementTime = now;

            // Show speaking indicator
            const indicator = document.getElementById('speakingIndicator');
            const speakingText = document.getElementById('speakingText');
            indicator.style.display = 'flex';

            // Clear any ongoing speech
            speechSynthesis.cancel();

            // Get available voices
            const voices = speechSynthesis.getVoices();
            const arabicVoice = voices.find(v => v.lang.startsWith('ar') || v.lang.includes('ar'));
            const englishVoice = voices.find(v => v.lang.startsWith('en') || v.lang.includes('en'));

            console.log("ğŸ™ï¸ Available voices:", voices.length);
            console.log("ğŸ™ï¸ Arabic voice:", arabicVoice?.name || 'Default');
            console.log("ğŸ™ï¸ English voice:", englishVoice?.name || 'Default');

            // 1. ARABIC ANNOUNCEMENT - FIRST
            const arabicText = `Ø§Ù„ØªØ°ÙƒØ±Ø© Ø±Ù‚Ù… ${ticketNumber}ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${roomAr}`;
            const utteranceAr = new SpeechSynthesisUtterance(arabicText);
            utteranceAr.lang = 'ar-SA';
            utteranceAr.rate = 0.8;  // Ø³Ø±Ø¹Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
            utteranceAr.pitch = 1;
            utteranceAr.volume = 1;
            
            if (arabicVoice) {
                utteranceAr.voice = arabicVoice;
            }

            // 2. ENGLISH ANNOUNCEMENT - SECOND
            const englishText = `Ticket number ${ticketNumber}, please proceed to ${roomEn}`;
            const utteranceEn = new SpeechSynthesisUtterance(englishText);
            utteranceEn.lang = 'en-US';
            utteranceEn.rate = 0.8;  // Ù†ÙØ³ Ø§Ù„Ø³Ø±Ø¹Ø©
            utteranceEn.pitch = 1;
            utteranceEn.volume = 1;
            
            if (englishVoice) {
                utteranceEn.voice = englishVoice;
            }

            // Event handlers
            utteranceAr.onstart = () => {
                speakingText.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©...";
                console.log("ğŸ”Š Starting Arabic announcement");
            };

            utteranceEn.onstart = () => {
                speakingText.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©...";
                console.log("ğŸ”Š Starting English announcement");
            };

            utteranceAr.onerror = (event) => {
                console.error("âŒ Arabic announcement error:", event.error);
                isSpeaking = false;
                indicator.style.display = 'none';
            };

            utteranceEn.onerror = (event) => {
                console.error("âŒ English announcement error:", event.error);
                isSpeaking = false;
                indicator.style.display = 'none';
            };

            utteranceEn.onend = () => {
                console.log("âœ… Announcement completed");
                isSpeaking = false;
                indicator.style.display = 'none';
            };

            // Start with Arabic, then English after 2 seconds
            console.log("ğŸ™ï¸ Starting Arabic announcement...");
            speechSynthesis.speak(utteranceAr);

            utteranceAr.onend = () => {
                console.log("âœ… Arabic announcement completed");
                setTimeout(() => {
                    console.log("ğŸ™ï¸ Starting English announcement...");
                    speechSynthesis.speak(utteranceEn);
                }, 2000); // Wait 2 seconds between languages
            };
        }

        // === Update Current Call Display ===
        function updateCurrentCall(callData) {
            if (!callData) {
                document.getElementById('noCurrentCall').style.display = 'block';
                document.getElementById('currentCallDisplay').style.display = 'none';
                return;
            }

            const dept = DEPARTMENTS[callData.deptId];
            if (!dept) return;

            document.getElementById('noCurrentCall').style.display = 'none';
            document.getElementById('currentCallDisplay').style.display = 'block';
            
            document.getElementById('ticketNumber').textContent = callData.ticketNumber;
            document.getElementById('deptNameAr').textContent = dept.nameAr;
            document.getElementById('deptNameEn').textContent = dept.nameEn;
            document.getElementById('roomAr').textContent = dept.roomAr;
            document.getElementById('roomEn').textContent = dept.roomEn;

            // Announce the call
            speakAnnouncement(
                callData.ticketNumber,
                dept.roomAr,
                dept.roomEn,
                dept.nameAr,
                dept.nameEn
            );
        }

        // === Update Recent Calls ===
        function updateRecentCalls(calls) {
            const container = document.getElementById('recentCallsList');
            const noCallsMsg = document.getElementById('noRecentCalls');
            
            if (!calls || calls.length === 0) {
                container.innerHTML = '';
                noCallsMsg.style.display = 'block';
                return;
            }

            noCallsMsg.style.display = 'none';
            container.innerHTML = calls.map(call => {
                const dept = DEPARTMENTS[call.deptId];
                const time = call.calledAt?.toDate 
                    ? call.calledAt.toDate().toLocaleTimeString('ar-SA')
                    : new Date(call.calledAt).toLocaleTimeString('ar-SA');

                return `
                    <div class="recent-ticket" style="border-color: ${dept?.color || '#3b82f6'}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.8vw; font-weight: bold;">${call.number}</div>
                                <div style="font-size: 1.2vw; color: #cbd5e1; margin-top: 5px;">
                                    ${dept?.nameAr || ''}
                                </div>
                            </div>
                            <div style="text-align: left;">
                                <div style="font-size: 1vw; color: #94a3b8;">${time}</div>
                                <div style="font-size: 1.5vw; opacity: 0.7; margin-top: 5px;">
                                    <i class="fas ${dept?.icon || 'fa-ticket-alt'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === Time Update ===
        function updateTime() {
            const now = new Date();
            
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('ar-SA', { 
                    hour12: true,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ar-SA', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
        }

        // === Initialize Firebase Listeners ===
        function initFirebaseListeners() {
            // Listen for current calls from Realtime Database
            db.ref('currentCalls').on('value', (snapshot) => {
                const calls = snapshot.val() || {};
                
                // Find the most recent call
                let latestCall = null;
                let latestTime = 0;
                
                Object.entries(calls).forEach(([deptId, call]) => {
                    if (call && call.calledAt > latestTime) {
                        latestTime = call.calledAt;
                        latestCall = { deptId, ...call };
                    }
                });
                
                currentCall = latestCall;
                updateCurrentCall(latestCall);
                
                console.log("ğŸ“ Current call updated:", latestCall);
            });

            // Listen for called tickets from Firestore
            firestore.collection('tickets')
                .where('status', '==', 'called')
                .orderBy('calledAt', 'desc')
                .limit(6)
                .onSnapshot((snapshot) => {
                    recentCalls = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        recentCalls.push({
                            id: doc.id,
                            number: data.number,
                            deptId: data.deptId,
                            calledAt: data.calledAt
                        });
                    });
                    
                    updateRecentCalls(recentCalls);
                    console.log("ğŸ“‹ Recent calls updated:", recentCalls.length);
                }, (error) => {
                    console.error("âŒ Error listening to tickets:", error);
                });

            // Update connection status
            db.ref('.info/connected').on('value', (snapshot) => {
                const isConnected = snapshot.val();
                document.getElementById('statusText').textContent = 
                    isConnected ? 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…' : 'ØºÙŠØ± Ù…ØªØµÙ„';
                
                if (!isConnected) {
                    document.getElementById('statusText').style.color = '#ef4444';
                }
            });
        }

        // === Initialize Everything ===
        function init() {
            console.log("ğŸš€ Initializing Display System...");
            
            // Initialize speech synthesis
            initSpeechSynthesis();
            
            // Start time updates
            updateTime();
            setInterval(updateTime, 1000);
            
            // Initialize Firebase listeners
            initFirebaseListeners();
            
            // Force voices to load
            if ('speechSynthesis' in window) {
                setTimeout(() => {
                    const voices = speechSynthesis.getVoices();
                    console.log("ğŸ™ï¸ Loaded voices:", voices.length);
                }, 1000);
            }
            
            console.log("âœ… Display System Initialized");
        }

        // Start the system when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Test function (for debugging)
        window.testAnnouncement = function() {
            speakAnnouncement(
                "123",
                "Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª",
                "Vehicles Office",
                "Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª",
                "Vehicles Department"
            );
        };
    </script>
</body>
</html>
