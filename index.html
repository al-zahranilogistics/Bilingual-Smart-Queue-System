<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الزهراني اللوجستية - نظام إدارة الطوابير</title>
    
    <!-- CSS Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --accent-teal: #06b6d4;
            --success-green: #10b981;
        }
        
        body { 
            font-family: 'Cairo', 'Inter', sans-serif; 
            margin: 0; 
            overflow-x: hidden;
            background: #f8fafc;
        }
        
        /* Utility Classes */
        .arabic { font-family: 'Cairo', sans-serif; }
        .english { font-family: 'Inter', sans-serif; direction: ltr; text-align: left; }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        
        .icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }
        
        .oval-logo {
            width: 100px;
            height: 50px;
            border-radius: 50% / 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .oval-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid #86efac;
        }
        
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        /* Screen Management */
        [data-screen] {
            display: none;
            min-height: 100vh;
        }
        
        [data-screen].active {
            display: block;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            text-decoration: none;
            border: 2px solid transparent;
        }
        
        .nav-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
        }
        
        /* Login Screen Styles */
        .login-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: 20px auto;
        }
        
        .login-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .login-form {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .error-message {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* Dashboard Styles */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .dashboard-content {
            padding: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 8px;
        }
        
        .ticket-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-btn {
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .call-btn {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }
        
        .complete-btn {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .queue-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .queue-table th {
            background: #f8fafc;
            padding: 15px;
            text-align: right;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 700;
            color: #374151;
        }
        
        .queue-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        
        .ticket-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-waiting {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-called {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .department-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            margin-bottom: 20px;
        }
        
        /* Display Screen Styles */
        .tv-display {
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0c1a2d 0%, #162a45 100%);
            overflow: hidden;
            position: relative;
        }
        
        .display-header {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #60a5fa;
        }
        
        .display-logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .display-company-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .display-main-content {
            display: flex;
            height: calc(100vh - 85px);
        }
        
        .current-call-section {
            flex: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            border-right: 3px solid #3b82f6;
        }
        
        .call-title {
            font-size: 2rem;
            color: #60a5fa;
            margin-bottom: 20px;
        }
        
        .ticket-number {
            font-size: 15rem;
            font-weight: 900;
            color: white;
            text-shadow: 
                0 0 20px #3b82f6,
                0 0 40px #3b82f6,
                0 0 60px #3b82f6;
            margin: 20px 0;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px #3b82f6; }
            to { text-shadow: 0 0 40px #3b82f6, 0 0 80px #3b82f6; }
        }
        
        .dept-name-arabic {
            font-size: 2.5rem;
            color: #93c5fd;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .dept-name-english {
            font-size: 1.8rem;
            color: #bfdbfe;
            margin-bottom: 20px;
        }
        
        .room-info {
            font-size: 1.5rem;
            color: #dbeafe;
            background: rgba(59, 130, 246, 0.2);
            padding: 12px 25px;
            border-radius: 12px;
            margin: 10px 0;
        }
        
        .recent-calls-section {
            flex: 0.3;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            overflow-y: auto;
        }
        
        .recent-title {
            font-size: 1.5rem;
            color: #60a5fa;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
            text-align: center;
        }
        
        .recent-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-right: 5px solid;
        }
        
        .ticker {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            padding: 12px 0;
            overflow: hidden;
        }
        
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 40s linear infinite;
            font-size: 1.1rem;
            padding-left: 100%;
        }
        
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .no-calls {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        
        .speaking-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f59e0b;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        .main-footer {
            background: #1e293b;
            color: white;
            padding: 30px 20px;
            margin-top: 50px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #60a5fa;
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 8px;
        }
        
        .footer-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #60a5fa;
        }
        
        /* Department Login Cards */
        .dept-login-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dept-login-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .dept-login-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dept-login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }
        
        .dept-login-card.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f8fafc, #f0f9ff);
        }
        
        .dept-login-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
        }
        
        .dept-login-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1e293b;
        }
        
        .dept-login-room {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 15px;
        }
        
        .login-hint {
            text-align: center;
            margin-top: 30px;
            color: #64748b;
            font-size: 0.9rem;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px dashed #cbd5e1;
        }
        
        .admin-login-btn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            margin-top: 20px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status">
        <i class="fas fa-wifi"></i>
        <span>جاري الاتصال...</span>
    </div>

    <!-- Main Navigation (Hidden in Login/Display Screens) -->
    <nav id="mainNav" class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- Logo and Company -->
                <div class="flex items-center gap-3">
                    <div class="oval-logo">
                        <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo">
                    </div>
                    <div class="arabic">
                        <h1 class="text-xl font-bold text-gray-800">الزهراني للخدمات اللوجستية</h1>
                        <p class="text-sm text-blue-600">نظام إدارة الطوابير الذكي</p>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex flex-wrap items-center gap-2">
                    <!-- Language Toggle -->
                    <button id="languageToggle" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-2">
                        <span id="languageText" class="font-medium text-blue-600">ع</span>
                        <i class="fas fa-globe text-gray-500"></i>
                    </button>
                    
                    <!-- Screen Navigation -->
                    <button data-screen="visitor" class="nav-btn bg-blue-600 text-white hover:bg-blue-700">
                        <i class="fas fa-user"></i>
                        شاشة الزوار
                    </button>
                    
                    <button data-screen="display" class="nav-btn bg-green-600 text-white hover:bg-green-700">
                        <i class="fas fa-tv"></i>
                        شاشة العرض
                    </button>
                    
                    <button data-screen="admin" class="nav-btn bg-red-600 text-white hover:bg-red-700">
                        <i class="fas fa-cog"></i>
                        دخول الموظفين
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ==================== SCREEN 1: VISITOR SCREEN ==================== -->
    <main id="visitorScreen" data-screen="visitor" class="active max-w-7xl mx-auto px-4 py-8">
        <div class="text-center mb-10 fade-in">
            <h1 id="welcomeText" class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
                مرحباً بكم في شركة الزهراني
            </h1>
            <p id="selectDeptText" class="text-gray-600 text-lg">
                اختر القسم المناسب لخدمتكم
            </p>
        </div>
        
        <!-- Departments Grid -->
        <div id="departmentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
            <!-- Departments will be loaded here -->
        </div>
        
        <!-- System Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card text-center fade-in" style="animation-delay: 0.1s">
                <div id="waitingCount" class="text-3xl font-bold text-blue-600">0</div>
                <div class="text-gray-600">في الانتظار</div>
            </div>
            <div class="card text-center fade-in" style="animation-delay: 0.2s">
                <div id="calledCount" class="text-3xl font-bold text-green-600">0</div>
                <div class="text-gray-600">المنداء عليهم</div>
            </div>
            <div class="card text-center fade-in" style="animation-delay: 0.3s">
                <div id="totalCount" class="text-3xl font-bold text-purple-600">0</div>
                <div class="text-gray-600">إجمالي التذاكر</div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="card bg-blue-50 border-blue-100 fade-in" style="animation-delay: 0.4s">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-500"></i>
                تعليمات الاستخدام
            </h3>
            <ol id="instructionsList" class="space-y-2 text-gray-700 list-decimal pr-5">
                <li>اختر القسم المناسب لخدمتك</li>
                <li>احفظ رقم التذكرة المعروض</li>
                <li>اجلس في منطقة الانتظار</li>
                <li>انتظر حتى ظهور رقمك على الشاشة</li>
                <li>توجه إلى المكتب المحدد عند النداء</li>
            </ol>
        </div>
        
        <!-- Footer -->
        <footer class="main-footer mt-12 rounded-xl">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>عن الشركة</h3>
                    <p class="text-gray-300">الزهراني للخدمات اللوجستية - تقدم حلولاً لوجستية متكاملة مع أفضل معايير الجودة والكفاءة.</p>
                </div>
                <div class="footer-section">
                    <h3>روابط سريعة</h3>
                    <ul class="footer-links">
                        <li><button data-screen="visitor" class="text-left">شاشة الزوار</button></li>
                        <li><button data-screen="display" class="text-left">شاشة العرض</button></li>
                        <li><button data-screen="admin" class="text-left">دخول الموظفين</button></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>معلومات الاتصال</h3>
                    <ul class="footer-links">
                        <li><i class="fas fa-phone ml-2"></i> الدعم الفني: 0906212</li>
                        <li><i class="fas fa-clock ml-2"></i> ساعات العمل: 8 صباحاً - 5 مساءً</li>
                        <li><i class="fas fa-map-marker-alt ml-2"></i> المملكة العربية السعودية</li>
                    </ul>
                </div>
            </div>
            <div class="text-center text-gray-400 mt-8 pt-6 border-t border-gray-700">
                <p>© 2025 الزهراني للخدمات اللوجستية. جميع الحقوق محفوظة.</p>
            </div>
        </footer>
    </main>

    <!-- ==================== SCREEN 2: DISPLAY SCREEN ==================== -->
    <div id="displayScreen" data-screen="display" class="tv-display">
        <!-- Header -->
        <div class="display-header">
            <div class="display-logo-section">
                <div class="oval-logo">
                    <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo">
                </div>
                <div class="display-company-name">
                    الزهراني للخدمات اللوجستية
                </div>
            </div>
            
            <div class="time-display">
                <div id="displayCurrentTime" class="current-time">00:00:00</div>
                <div id="displayCurrentDate" class="current-date">الاثنين ١ يناير ٢٠٢٤</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="display-main-content">
            <!-- Current Call Section -->
            <div class="current-call-section">
                <div id="speakingIndicator" class="speaking-indicator hidden">
                    <i class="fas fa-volume-up"></i>
                    جاري النداء
                </div>
                
                <div id="noCurrentCall" class="no-calls">
                    <i class="fas fa-volume-off"></i>
                    <h3>لا يوجد تذاكر حالياً</h3>
                    <p>في انتظار تذاكر جديدة...</p>
                </div>
                
                <div id="currentCallInfo" class="text-center hidden">
                    <div class="call-title">التذكرة الحالية</div>
                    <div id="displayTicketNumber" class="ticket-number">0</div>
                    <div id="displayDeptArabic" class="dept-name-arabic">قسم المركبات</div>
                    <div id="displayDeptEnglish" class="dept-name-english">Vehicles Department</div>
                    <div id="displayRoomArabic" class="room-info">مكتب المركبات</div>
                    <div id="displayRoomEnglish" class="room-info">Vehicles Office</div>
                </div>
            </div>
            
            <!-- Recent Calls Section -->
            <div class="recent-calls-section">
                <div class="recent-title">آخر ١٠ تذاكر</div>
                <div id="recentCallsList"></div>
            </div>
        </div>
        
        <!-- Ticker -->
        <div class="ticker">
            <div class="ticker-content" id="tickerContent">
                • مرحباً بكم في شركة الزهراني للخدمات اللوجستية • نظام إدارة الطوابير الذكي • يرجى الانتظار في منطقة الانتظار حتى نداء رقمك • شكراً لتفهمكم •
            </div>
        </div>
    </div>

    <!-- ==================== SCREEN 3: ADMIN LOGIN SELECTION ==================== -->
    <div id="adminLoginScreen" data-screen="admin" class="min-h-screen p-4 bg-gradient-to-br from-blue-50 to-gray-50">
        <div class="dept-login-container">
            <div class="text-center mb-10">
                <div class="oval-logo mx-auto mb-6">
                    <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo">
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-3">دخول الموظفين</h1>
                <p class="text-gray-600 text-lg">اختر القسم الخاص بك للدخول إلى لوحة التحكم</p>
            </div>
            
            <!-- Department Selection Grid -->
            <div class="dept-login-grid" id="deptLoginGrid">
                <!-- Departments will be loaded here -->
            </div>
            
            <!-- Admin Login Button -->
            <div class="max-w-md mx-auto mt-10">
                <button id="adminLoginBtn" class="admin-login-btn">
                    <i class="fas fa-user-shield mr-2"></i>
                    دخول مدير النظام (لجميع الأقسام)
                </button>
            </div>
            
            <div class="login-hint mt-8">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>معلومة:</strong> كلمة المرور لجميع الأقسام هي <strong>00</strong>
            </div>
            
            <div class="text-center mt-12 text-gray-500 text-sm">
                <p>© 2025 الزهراني للخدمات اللوجستية - نظام إدارة الطوابير الذكي</p>
                <p class="mt-1">للحصول على مساعدة، اتصل بالدعم الفني: 0906212</p>
            </div>
        </div>
    </div>

    <!-- ==================== SCREEN 4: DEPARTMENT PASSWORD SCREEN ==================== -->
    <div id="deptPasswordScreen" data-screen="dept-password" class="hidden">
        <div class="flex items-center justify-center min-h-screen p-4 bg-gradient-to-br from-blue-50 to-gray-50">
            <div class="login-container">
                <div class="login-header">
                    <div class="oval-logo mx-auto mb-4">
                        <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo">
                    </div>
                    <h2 id="deptLoginTitle" class="text-xl font-bold">الدخول إلى القسم</h2>
                    <p id="deptLoginSubtitle" class="opacity-90">أدخل كلمة المرور للوصول إلى لوحة التحكم</p>
                </div>
                
                <div class="login-form">
                    <div id="passwordErrorMessage" class="error-message">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="passwordErrorText">كلمة المرور غير صحيحة</span>
                    </div>
                    
                    <div class="text-center mb-6">
                        <div id="selectedDeptIcon" class="icon-wrapper mx-auto mb-4">
                            <!-- Icon will be set dynamically -->
                        </div>
                        <h3 id="selectedDeptName" class="text-xl font-bold text-gray-800 mb-2">قسم المركبات</h3>
                        <p id="selectedDeptRoom" class="text-gray-600">مكتب المركبات</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="deptPassword" class="form-label">
                            <i class="fas fa-lock mr-2"></i>
                            كلمة المرور
                        </label>
                        <input type="password" id="deptPassword" class="form-input text-center text-2xl tracking-widest" 
                               placeholder="00" maxlength="2" inputmode="numeric">
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="backToDeptSelect" class="btn-primary flex-1 bg-gray-500 hover:bg-gray-600">
                            <i class="fas fa-arrow-right ml-2"></i>
                            رجوع
                        </button>
                        <button id="deptLoginBtn" class="btn-primary flex-1">
                            <span id="deptLoginText">دخول</span>
                            <span id="deptLoginSpinner" class="hidden loading"></span>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center text-gray-500 text-sm">
                        <p>كلمة المرور: <strong>00</strong></p>
                        <p class="mt-1">لجميع أقسام الموظفين</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SCREEN 5: ADMIN DASHBOARD ==================== -->
    <div id="adminDashboardScreen" data-screen="admin-dashboard" class="hidden">
        <div class="dashboard-header">
            <div class="flex items-center gap-4">
                <div class="oval-logo">
                    <img src="https://i.ibb.co/1GHY3whz/bsxB90Z.png" alt="Al-Zahrani Logo">
                </div>
                <div>
                    <h1 class="text-xl font-bold">لوحة تحكم الموظفين</h1>
                    <p class="opacity-90 text-sm" id="welcomeMessage">مرحباً بك في قسم المركبات</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div id="currentTime" class="font-mono">00:00:00</div>
                    <div id="currentDate" class="text-sm opacity-80">الاثنين ١ يناير ٢٠٢٤</div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt ml-2"></i>
                    تسجيل الخروج
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number text-blue-600" id="statWaiting">0</div>
                    <div class="text-gray-600">في الانتظار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-green-600" id="statCalled">0</div>
                    <div class="text-gray-600">المنداء عليهم</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-purple-600" id="statCompleted">0</div>
                    <div class="text-gray-600">المكتملة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-orange-600" id="statTotal">0</div>
                    <div class="text-gray-600">إجمالي التذاكر</div>
                </div>
            </div>
            
            <!-- Department Selection (Admin only) -->
            <div id="adminDeptSelect" class="card hidden">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-building text-blue-500"></i>
                    اختيار القسم للتحكم
                </h2>
                <select id="departmentSelect" class="department-select">
                    <option value="">اختر القسم للتحكم...</option>
                    <option value="vehicles">قسم المركبات</option>
                    <option value="finance">قسم المالية</option>
                    <option value="supervisors">مدير التشغيل</option>
                    <option value="ninja_sup">مشرف نينجا</option>
                    <option value="kmart_ninja">مشرف كيمارت</option>
                    <option value="hr">الموارد البشرية</option>
                    <option value="petroleum">قسم البترول</option>
                    <option value="naqel_mgr">مدير تشغيل ناقل</option>
                    <option value="ninja_mgr">مشروع نينجا</option>
                </select>
            </div>
            
            <!-- Current Department Info -->
            <div class="card bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-500"></i>
                    معلومات القسم الحالي
                </h2>
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div id="currentDeptIcon" class="icon-wrapper" style="width: 80px; height: 80px; font-size: 32px;">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="flex-1">
                        <h3 id="currentDeptName" class="text-2xl font-bold text-gray-800 mb-2">قسم المركبات</h3>
                        <p id="currentDeptRoom" class="text-gray-600 text-lg">مكتب المركبات</p>
                        <div class="mt-2">
                            <span id="currentDeptRole" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                موظف القسم
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ticket Controls -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-ticket-alt text-green-500"></i>
                    التحكم في التذاكر
                </h2>
                
                <div class="ticket-controls">
                    <button id="callNextBtn" class="control-btn call-btn" disabled>
                        <i class="fas fa-volume-up"></i>
                        نداء التالي
                    </button>
                    
                    <button id="completeTicketBtn" class="control-btn complete-btn" disabled>
                        <i class="fas fa-check-circle"></i>
                        إكمال التذكرة
                    </button>
                    
                    <button id="cancelTicketBtn" class="control-btn cancel-btn" disabled>
                        <i class="fas fa-times-circle"></i>
                        إلغاء التذكرة
                    </button>
                    
                    <button id="resetQueueBtn" class="control-btn reset-btn">
                        <i class="fas fa-redo"></i>
                        إعادة ضبط الطابور
                    </button>
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <div class="font-bold text-blue-800 mb-2">التذكرة الحالية:</div>
                    <div id="currentTicketInfo" class="text-gray-600">لا توجد تذكرة مختارة</div>
                </div>
            </div>
            
            <!-- Queue List -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-list-ol text-purple-500"></i>
                    قائمة الطابور - <span id="queueDeptName">قسم المركبات</span>
                </h2>
                
                <div class="overflow-x-auto">
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th>رقم التذكرة</th>
                                <th>القسم</th>
                                <th>الوقت</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="queueTableBody">
                            <!-- Tickets will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyQueueMessage" class="text-center py-8 text-gray-500">
                    <i class="fas fa-ticket-alt text-3xl mb-3"></i>
                    <p>لا توجد تذاكر في الوقت الحالي</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->
    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content fade-in">
            <button class="close-modal" onclick="closeSuccessModal()">×</button>
            <div class="text-center space-y-6">
                <i class="fas fa-ticket-alt text-5xl text-blue-500"></i>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">تم استخراج تذكرتك!</h3>
                    <div id="ticketNumber" class="text-6xl font-black text-blue-600 mt-4 tracking-wider">
                        123
                    </div>
                    <div class="mt-4 space-y-2">
                        <div id="ticketDept" class="text-lg font-medium text-gray-700">
                            القسم: قسم المركبات
                        </div>
                        <div class="text-gray-600">
                            يرجى الانتظار حتى نداء رقمك
                        </div>
                    </div>
                </div>
                <button onclick="closeSuccessModal()" class="btn-primary w-full">
                    تم
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content fade-in">
            <div class="text-center space-y-6">
                <i class="fas fa-question-circle text-5xl text-yellow-500"></i>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800" id="confirmTitle">تأكيد العملية</h3>
                    <p class="text-gray-600 mt-2" id="confirmMessage">هل أنت متأكد من تنفيذ هذه العملية؟</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="confirmAction(false)" class="btn-primary flex-1 bg-gray-500 hover:bg-gray-600">
                        إلغاء
                    </button>
                    <button onclick="confirmAction(true)" class="btn-primary flex-1" id="confirmBtn">
                        تأكيد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content fade-in">
            <button class="close-modal" onclick="closeMessageModal()">×</button>
            <div class="text-center space-y-6">
                <i id="messageIcon" class="fas fa-info-circle text-5xl text-blue-500"></i>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800" id="messageTitle">رسالة</h3>
                    <p class="text-gray-600 mt-2" id="messageText"></p>
                </div>
                <button onclick="closeMessageModal()" class="btn-primary w-full">
                    موافق
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA2WwSnB54y4Xf3p_WPFHeSf7QOGgi3rS8",
            authDomain: "zahrani-4bbf3.firebaseapp.com",
            databaseURL: "https://zahrani-4bbf3-default-rtdb.firebaseio.com",
            projectId: "zahrani-4bbf3",
            storageBucket: "zahrani-4bbf3.firebasestorage.app",
            messagingSenderId: "76127187270",
            appId: "1:76127187270:web:c0d8869fc61275da5ab547"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const realtimeDB = firebase.database();

        // ==================== SYSTEM CONFIGURATION ====================
        const DEPARTMENTS = {
            vehicles: { 
                id: 'vehicles', 
                nameAr: "قسم المركبات", 
                nameEn: "Vehicles Department", 
                color: "#3b82f6", 
                icon: "fa-truck", 
                roomAr: "مكتب المركبات", 
                roomEn: "Vehicles Office",
                username: "مدير المركبات",
                password: "00"
            },
            finance: { 
                id: 'finance', 
                nameAr: "قسم المالية", 
                nameEn: "Finance Department", 
                color: "#10b981", 
                icon: "fa-money-bill-wave", 
                roomAr: "مكتب المدير المالي", 
                roomEn: "Finance Office",
                username: "المدير المالي",
                password: "00"
            },
            supervisors: { 
                id: 'supervisors', 
                nameAr: "مدير التشغيل", 
                nameEn: "Supervisors Department", 
                color: "#8b5cf6", 
                icon: "fa-user-tie", 
                roomAr: "مكتب مدير التشغيل", 
                roomEn: "Supervisors Office",
                username: "مدير التشغيل",
                password: "00"
            },
            ninja_sup: { 
                id: 'ninja_sup', 
                nameAr: "مشرف نينجا", 
                nameEn: "Ninja Supervisor", 
                color: "#ec4899", 
                icon: "fa-user-ninja", 
                roomAr: "مكتب مشرف نينجا", 
                roomEn: "Ninja Supervisor Office",
                username: "مشرف نينجا",
                password: "00"
            },
            kmart_ninja: { 
                id: 'kmart_ninja', 
                nameAr: "مشرف كيمارت", 
                nameEn: "K-Mart Department", 
                color: "#f59e0b", 
                icon: "fa-store", 
                roomAr: "مكتب كيمارت", 
                roomEn: "K-Mart Office",
                username: "مشرف كيمارت",
                password: "00"
            },
            hr: { 
                id: 'hr', 
                nameAr: "الموارد البشرية", 
                nameEn: "Human Resources", 
                color: "#ef4444", 
                icon: "fa-users", 
                roomAr: "مكتب الموارد البشرية", 
                roomEn: "HR Office",
                username: "مدير الموارد البشرية",
                password: "00"
            },
            petroleum: { 
                id: 'petroleum', 
                nameAr: "قسم البترول", 
                nameEn: "Petroleum Department", 
                color: "#06b6d4", 
                icon: "fa-gas-pump", 
                roomAr: "مكتب البترول", 
                roomEn: "Petroleum Office",
                username: "مدير البترول",
                password: "00"
            },
            naqel_mgr: { 
                id: 'naqel_mgr', 
                nameAr: "مدير تشغيل ناقل", 
                nameEn: "Naqel Project", 
                color: "#8b5cf6", 
                icon: "fa-truck-fast", 
                roomAr: "مكتب مدير التشغيل", 
                roomEn: "Naqel Project Office",
                username: "مدير مشروع ناقل",
                password: "00"
            },
            ninja_mgr: { 
                id: 'ninja_mgr', 
                nameAr: "مشروع نينجا", 
                nameEn: "Ninja Project", 
                color: "#6366f1", 
                icon: "fa-bolt", 
                roomAr: "مكتب مشروع نينجا", 
                roomEn: "Ninja Project Office",
                username: "مدير مشروع نينجا",
                password: "00"
            }
        };

        // ==================== ADMIN CREDENTIALS ====================
        const ADMIN_CREDENTIALS = {
            username: "مدير النظام",
            password: "00",
            role: "admin",
            dept: "all"
        };

        // ==================== LANGUAGE CONFIGURATION ====================
        const LANGUAGES = {
            ar: {
                welcome: "مرحباً بكم في شركة الزهراني",
                selectDept: "اختر القسم المناسب لخدمتكم",
                waiting: "في الانتظار",
                lastNumber: "آخر رقم",
                instructions: "تعليمات الاستخدام",
                instruction1: "اختر القسم المناسب لخدمتك",
                instruction2: "احفظ رقم التذكرة المعروض",
                instruction3: "اجلس في منطقة الانتظار",
                instruction4: "انتظر حتى ظهور رقمك على الشاشة",
                instruction5: "توجه إلى المكتب المحدد عند النداء",
                generateTicket: "توليد تذكرة",
                connected: "متصل",
                disconnected: "غير متصل",
                currentTicket: "التذكرة الحالية",
                last10Tickets: "آخر ١٠ تذاكر",
                noTickets: "لا يوجد تذاكر حالياً",
                waitingNew: "في انتظار تذاكر جديدة...",
                speakingNow: "جاري النداء",
                employeeLogin: "دخول الموظفين",
                selectYourDept: "اختر القسم الخاص بك",
                enterPassword: "أدخل كلمة المرور",
                passwordHint: "كلمة المرور: 00",
                adminLogin: "دخول مدير النظام",
                welcomeDept: "مرحباً بك في",
                deptEmployee: "موظف القسم",
                adminRole: "مدير النظام"
            },
            en: {
                welcome: "Welcome to Al-Zahrani Company",
                selectDept: "Select the appropriate department",
                waiting: "Waiting",
                lastNumber: "Last Number",
                instructions: "Usage Instructions",
                instruction1: "Select the appropriate department",
                instruction2: "Save the displayed ticket number",
                instruction3: "Sit in the waiting area",
                instruction4: "Wait for your number to appear on screen",
                instruction5: "Proceed to the specified office when called",
                generateTicket: "Generate Ticket",
                connected: "Connected",
                disconnected: "Disconnected",
                currentTicket: "Current Ticket",
                last10Tickets: "Last 10 Tickets",
                noTickets: "No tickets currently",
                waitingNew: "Waiting for new tickets...",
                speakingNow: "Speaking Now",
                employeeLogin: "Employee Login",
                selectYourDept: "Select Your Department",
                enterPassword: "Enter Password",
                passwordHint: "Password: 00",
                adminLogin: "Admin Login",
                welcomeDept: "Welcome to",
                deptEmployee: "Department Employee",
                adminRole: "System Administrator"
            }
        };

        // ==================== GLOBAL VARIABLES ====================
        let currentLanguage = 'ar';
        let isOnline = true;
        let currentScreen = 'visitor';
        let currentUser = null;
        let selectedDepartment = null;
        let currentTicket = null;
        let tickets = [];
        let calledTickets = [];
        let recentTickets = [];
        let ticketsListener = null;
        let isGeneratingTicket = false;
        let pendingAction = null;
        let selectedDeptForLogin = null;

        // ==================== INITIALIZATION ====================
        async function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            updateLanguage();
            initDepartments();
            initLoginDepartments();
            initFirebaseListeners();
            updateConnectionStatus();
            
            await initializeCounters();
            
            setupScreenNavigation();
            setupEventListeners();
            
            checkSavedSession();
            showScreen(currentScreen);
        }

        // ==================== SCREEN MANAGEMENT ====================
        function setupScreenNavigation() {
            document.querySelectorAll('[data-screen]').forEach(btn => {
                if (btn.tagName === 'BUTTON') {
                    btn.addEventListener('click', () => {
                        const screen = btn.getAttribute('data-screen');
                        showScreen(screen);
                    });
                }
            });
        }

        function showScreen(screen) {
            currentScreen = screen;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-screen') === screen) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('[data-screen]').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-screen') === screen) {
                    el.classList.add('active');
                }
            });
            
            if (screen === 'admin' && currentUser) {
                document.getElementById('adminDashboardScreen').classList.add('active');
                document.getElementById('adminLoginScreen').classList.remove('active');
                document.getElementById('deptPasswordScreen').classList.remove('active');
            } else if (screen === 'admin') {
                document.getElementById('adminDashboardScreen').classList.remove('active');
                document.getElementById('adminLoginScreen').classList.add('active');
                document.getElementById('deptPasswordScreen').classList.remove('active');
            }
            
            const showNav = !['display', 'admin', 'dept-password'].includes(screen);
            document.getElementById('mainNav').style.display = showNav ? 'block' : 'none';
            
            if (screen === 'display') {
                updateCurrentCall();
                updateRecentCallsList();
            }
            
            if (screen === 'admin-dashboard' || (screen === 'admin' && currentUser)) {
                updateAdminStats();
                updateTicketsDisplay();
            }
        }

        // ==================== DATE & TIME ====================
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ar-EG', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateStr = now.toLocaleDateString('ar-EG', dateOptions);
            
            document.querySelectorAll('.current-time').forEach(el => {
                if (el.textContent !== timeStr) el.textContent = timeStr;
            });
            document.querySelectorAll('.current-date').forEach(el => {
                if (el.textContent !== dateStr) el.textContent = dateStr;
            });
        }

        // ==================== LANGUAGE MANAGEMENT ====================
        function updateLanguage() {
            const t = LANGUAGES[currentLanguage];
            const isRTL = currentLanguage === 'ar';
            
            document.body.dir = isRTL ? 'rtl' : 'ltr';
            document.getElementById('languageText').textContent = currentLanguage === 'ar' ? 'ع' : 'EN';
            document.getElementById('welcomeText').textContent = t.welcome;
            document.getElementById('selectDeptText').textContent = t.selectDept;
            document.getElementById('instructionsList').innerHTML = `
                <li>${t.instruction1}</li>
                <li>${t.instruction2}</li>
                <li>${t.instruction3}</li>
                <li>${t.instruction4}</li>
                <li>${t.instruction5}</li>
            `;
            
            if (document.querySelector('.call-title')) {
                document.querySelector('.call-title').textContent = t.currentTicket;
                document.querySelector('.recent-title').textContent = t.last10Tickets;
            }
            
            updateDepartmentDisplay();
            updateLoginDepartmentDisplay();
        }

        // ==================== DEPARTMENT FUNCTIONS ====================
        function initDepartments() {
            const container = document.getElementById('departmentsGrid');
            if (!container) return;
            
            container.innerHTML = Object.values(DEPARTMENTS).map(dept => `
                <div class="card hover:border-blue-300 fade-in">
                    <div class="flex flex-col items-center text-center">
                        <div class="icon-wrapper" style="background-color: ${dept.color}">
                            <i class="fas ${dept.icon}"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 dept-name">
                            ${currentLanguage === 'ar' ? dept.nameAr : dept.nameEn}
                        </h3>
                        <div class="text-sm text-gray-500 mb-3 dept-room">
                            ${currentLanguage === 'ar' ? dept.roomAr : dept.roomEn}
                        </div>
                        <div class="mt-2">
                            <div class="text-2xl font-bold text-gray-700 dept-last-number" data-dept="${dept.id}">0</div>
                            <div class="text-xs text-gray-500">${LANGUAGES[currentLanguage].lastNumber}</div>
                            <div class="mt-2 text-sm text-blue-600 dept-waiting" data-dept="${dept.id}">0 ${LANGUAGES[currentLanguage].waiting}</div>
                        </div>
                        <div class="mt-4">
                            <button onclick="generateTicket('${dept.id}')" class="btn-primary generate-btn" data-dept="${dept.id}">
                                <i class="fas fa-ticket-alt mr-2"></i>
                                ${LANGUAGES[currentLanguage].generateTicket}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateDepartmentDisplay() {
            const t = LANGUAGES[currentLanguage];
            
            document.querySelectorAll('.dept-name').forEach((el, index) => {
                const dept = Object.values(DEPARTMENTS)[index];
                if (dept) el.textContent = currentLanguage === 'ar' ? dept.nameAr : dept.nameEn;
            });
            
            document.querySelectorAll('.dept-room').forEach((el, index) => {
                const dept = Object.values(DEPARTMENTS)[index];
                if (dept) el.textContent = currentLanguage === 'ar' ? dept.roomAr : dept.roomEn;
            });
            
            document.querySelectorAll('.generate-btn').forEach(btn => {
                btn.innerHTML = `<i class="fas fa-ticket-alt mr-2"></i>${t.generateTicket}`;
            });
        }

        // ==================== LOGIN DEPARTMENT FUNCTIONS ====================
        function initLoginDepartments() {
            const container = document.getElementById('deptLoginGrid');
            if (!container) return;
            
            container.innerHTML = Object.values(DEPARTMENTS).map(dept => `
                <div class="dept-login-card fade-in" data-dept="${dept.id}">
                    <div class="dept-login-icon" style="background-color: ${dept.color}">
                        <i class="fas ${dept.icon}"></i>
                    </div>
                    <h3 class="dept-login-name">${dept.nameAr}</h3>
                    <p class="dept-login-room">${dept.roomAr}</p>
                    <div class="mt-4">
                        <div class="text-sm text-gray-500 mb-2">اسم المستخدم:</div>
                        <div class="font-bold text-gray-800">${dept.username}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-sm text-gray-500">كلمة المرور:</div>
                        <div class="font-mono text-xl text-gray-800">00</div>
                    </div>
                </div>
            `).join('');
            
            // Add click event to department cards
            document.querySelectorAll('.dept-login-card').forEach(card => {
                card.addEventListener('click', () => {
                    const deptId = card.getAttribute('data-dept');
                    showDeptPasswordScreen(deptId);
                });
            });
        }

        function updateLoginDepartmentDisplay() {
            document.querySelectorAll('.dept-login-card').forEach((card, index) => {
                const dept = Object.values(DEPARTMENTS)[index];
                if (dept) {
                    const name = card.querySelector('.dept-login-name');
                    const room = card.querySelector('.dept-login-room');
                    if (name) name.textContent = dept.nameAr;
                    if (room) room.textContent = dept.roomAr;
                }
            });
        }

        function showDeptPasswordScreen(deptId) {
            const dept = DEPARTMENTS[deptId];
            if (!dept) return;
            
            selectedDeptForLogin = dept;
            
            document.getElementById('deptLoginTitle').textContent = `الدخول إلى ${dept.nameAr}`;
            document.getElementById('deptLoginSubtitle').textContent = `أدخل كلمة المرور للوصول إلى لوحة التحكم`;
            
            const iconElement = document.getElementById('selectedDeptIcon');
            iconElement.className = 'icon-wrapper mx-auto mb-4';
            iconElement.style.backgroundColor = dept.color;
            iconElement.innerHTML = `<i class="fas ${dept.icon}"></i>`;
            
            document.getElementById('selectedDeptName').textContent = dept.nameAr;
            document.getElementById('selectedDeptRoom').textContent = dept.roomAr;
            
            document.getElementById('deptPassword').value = '';
            document.getElementById('passwordErrorMessage').classList.remove('show');
            
            document.getElementById('adminLoginScreen').classList.remove('active');
            document.getElementById('deptPasswordScreen').classList.add('active');
            document.getElementById('mainNav').style.display = 'none';
            
            currentScreen = 'dept-password';
        }

        function handleDeptLogin() {
            const password = document.getElementById('deptPassword').value;
            const errorElement = document.getElementById('passwordErrorMessage');
            const loginBtn = document.getElementById('deptLoginBtn');
            const loginText = document.getElementById('deptLoginText');
            const loginSpinner = document.getElementById('deptLoginSpinner');
            
            if (!selectedDeptForLogin) {
                showError('يرجى اختيار القسم أولاً');
                return;
            }
            
            loginText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            
            setTimeout(() => {
                if (password === selectedDeptForLogin.password) {
                    loginDeptSuccess(selectedDeptForLogin);
                } else {
                    showPasswordError('كلمة المرور غير صحيحة. الرجاء إدخال 00');
                }
                
                loginText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }, 800);
        }

        function loginDeptSuccess(dept) {
            currentUser = {
                username: dept.username,
                name: dept.nameAr,
                dept: dept.id,
                role: 'employee',
                deptData: dept
            };
            
            localStorage.setItem('zahrani_employee', JSON.stringify(currentUser));
            
            setupUserDashboard();
            showScreen('admin-dashboard');
        }

        function handleAdminLogin() {
            showDeptPasswordScreenForAdmin();
        }

        function showDeptPasswordScreenForAdmin() {
            selectedDeptForLogin = {
                id: 'admin',
                nameAr: 'مدير النظام',
                nameEn: 'System Administrator',
                color: '#f59e0b',
                icon: 'fa-user-shield',
                roomAr: 'لوحة التحكم الرئيسية',
                roomEn: 'Main Control Panel',
                username: 'مدير النظام',
                password: '00'
            };
            
            document.getElementById('deptLoginTitle').textContent = 'دخول مدير النظام';
            document.getElementById('deptLoginSubtitle').textContent = 'أدخل كلمة المرور للوصول إلى جميع الأقسام';
            
            const iconElement = document.getElementById('selectedDeptIcon');
            iconElement.className = 'icon-wrapper mx-auto mb-4';
            iconElement.style.backgroundColor = '#f59e0b';
            iconElement.innerHTML = `<i class="fas fa-user-shield"></i>`;
            
            document.getElementById('selectedDeptName').textContent = 'مدير النظام';
            document.getElementById('selectedDeptRoom').textContent = 'لوحة التحكم الرئيسية';
            
            document.getElementById('deptPassword').value = '';
            document.getElementById('passwordErrorMessage').classList.remove('show');
            
            document.getElementById('adminLoginScreen').classList.remove('active');
            document.getElementById('deptPasswordScreen').classList.add('active');
            document.getElementById('mainNav').style.display = 'none';
            
            currentScreen = 'dept-password';
        }

        function showPasswordError(message) {
            const errorElement = document.getElementById('passwordErrorMessage');
            const errorText = document.getElementById('passwordErrorText');
            
            if (errorElement && errorText) {
                errorText.textContent = message;
                errorElement.classList.add('show');
                
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 5000);
            }
        }

        // ==================== DASHBOARD SETUP ====================
        function setupUserDashboard() {
            if (!currentUser) return;
            
            const welcomeElement = document.getElementById('welcomeMessage');
            const deptSelectElement = document.getElementById('adminDeptSelect');
            const currentDeptIcon = document.getElementById('currentDeptIcon');
            const currentDeptName = document.getElementById('currentDeptName');
            const currentDeptRoom = document.getElementById('currentDeptRoom');
            const currentDeptRole = document.getElementById('currentDeptRole');
            const queueDeptName = document.getElementById('queueDeptName');
            
            if (currentUser.role === 'admin') {
                welcomeElement.textContent = `${LANGUAGES[currentLanguage].welcomeDept} لوحة التحكم الرئيسية`;
                deptSelectElement.classList.remove('hidden');
                currentDeptName.textContent = 'مدير النظام';
                currentDeptRoom.textContent = 'التحكم في جميع الأقسام';
                currentDeptRole.textContent = LANGUAGES[currentLanguage].adminRole;
                currentDeptIcon.style.backgroundColor = '#f59e0b';
                currentDeptIcon.innerHTML = `<i class="fas fa-user-shield"></i>`;
                queueDeptName.textContent = 'جميع الأقسام';
                
                const deptSelect = document.getElementById('departmentSelect');
                deptSelect.value = '';
                selectedDepartment = null;
                document.getElementById('callNextBtn').disabled = true;
            } else {
                welcomeElement.textContent = `${LANGUAGES[currentLanguage].welcomeDept} ${currentUser.name}`;
                deptSelectElement.classList.add('hidden');
                
                const dept = DEPARTMENTS[currentUser.dept];
                if (dept) {
                    currentDeptName.textContent = dept.nameAr;
                    currentDeptRoom.textContent = dept.roomAr;
                    currentDeptRole.textContent = LANGUAGES[currentLanguage].deptEmployee;
                    currentDeptIcon.style.backgroundColor = dept.color;
                    currentDeptIcon.innerHTML = `<i class="fas ${dept.icon}"></i>`;
                    queueDeptName.textContent = dept.nameAr;
                    
                    selectedDepartment = currentUser.dept;
                    updateTicketsDisplay();
                }
            }
        }

        // ==================== EVENT LISTENERS SETUP ====================
        function setupEventListeners() {
            // Language toggle
            document.getElementById('languageToggle')?.addEventListener('click', () => {
                currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
                updateLanguage();
            });
            
            // Admin login button
            document.getElementById('adminLoginBtn')?.addEventListener('click', handleAdminLogin);
            
            // Department login
            document.getElementById('deptLoginBtn')?.addEventListener('click', handleDeptLogin);
            
            // Back to department selection
            document.getElementById('backToDeptSelect')?.addEventListener('click', () => {
                document.getElementById('deptPasswordScreen').classList.remove('active');
                document.getElementById('adminLoginScreen').classList.add('active');
                currentScreen = 'admin';
            });
            
            // Enter key in password field
            document.getElementById('deptPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleDeptLogin();
            });
            
            // Department selection in dashboard
            document.getElementById('departmentSelect')?.addEventListener('change', handleDepartmentChange);
            
            // Ticket control buttons
            document.getElementById('callNextBtn')?.addEventListener('click', callNextTicket);
            document.getElementById('completeTicketBtn')?.addEventListener('click', completeCurrentTicket);
            document.getElementById('cancelTicketBtn')?.addEventListener('click', cancelCurrentTicket);
            document.getElementById('resetQueueBtn')?.addEventListener('click', resetQueue);
            
            // Logout button
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // ==================== SESSION MANAGEMENT ====================
        function checkSavedSession() {
            const savedUser = localStorage.getItem('zahrani_employee');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user && user.dept) {
                        if (user.role === 'admin') {
                            currentUser = user;
                            setupUserDashboard();
                            showScreen('admin-dashboard');
                        } else if (DEPARTMENTS[user.dept]) {
                            currentUser = user;
                            currentUser.deptData = DEPARTMENTS[user.dept];
                            setupUserDashboard();
                            showScreen('admin-dashboard');
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('zahrani_employee');
                }
            }
        }

        function handleLogout() {
            showConfirm('تسجيل الخروج', 'هل تريد تسجيل الخروج من النظام؟', () => {
                if (ticketsListener) {
                    ticketsListener();
                }
                
                currentUser = null;
                selectedDepartment = null;
                currentTicket = null;
                selectedDeptForLogin = null;
                
                localStorage.removeItem('zahrani_employee');
                
                showScreen('admin');
            });
        }

        // ==================== FIREBASE FUNCTIONS ====================
        async function initializeCounters() {
            try {
                for (const dept of Object.values(DEPARTMENTS)) {
                    const counterRef = db.collection('counters').doc(dept.id);
                    const doc = await counterRef.get();
                    
                    if (!doc.exists) {
                        await counterRef.set({
                            lastNumber: 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            } catch (error) {
                console.error('Error initializing counters:', error);
            }
        }

        async function getNextTicketNumber(deptId) {
            try {
                const counterRef = db.collection('counters').doc(deptId);
                
                const result = await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newNumber = 1;
                    
                    if (counterDoc.exists) {
                        const data = counterDoc.data();
                        newNumber = (data.lastNumber || 0) + 1;
                        if (newNumber > 10000) {
                            newNumber = 1;
                        }
                    }
                    
                    transaction.set(counterRef, {
                        lastNumber: newNumber,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    return newNumber;
                });
                
                return result.toString();
            } catch (error) {
                console.error('Error getting ticket number:', error);
                throw error;
            }
        }

        async function generateTicket(deptId) {
            if (!isOnline || isGeneratingTicket) return;
            
            isGeneratingTicket = true;
            const button = document.querySelector(`button[data-dept="${deptId}"]`);
            if (!button) return;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>جاري التوليد...';
            button.disabled = true;
            
            try {
                const dept = DEPARTMENTS[deptId];
                if (!dept) throw new Error('Department not found');
                
                const ticketNumber = await getNextTicketNumber(deptId);
                
                const ticket = {
                    id: `ticket_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    number: ticketNumber,
                    deptId,
                    displayText: ticketNumber,
                    status: 'waiting',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    departmentNameAr: dept.nameAr,
                    departmentNameEn: dept.nameEn,
                    roomAr: dept.roomAr,
                    roomEn: dept.roomEn
                };
                
                await db.collection('tickets').doc(ticket.id).set(ticket);
                
                showSuccessModal(ticketNumber, dept.nameAr, dept.nameEn);
                
            } catch (error) {
                console.error('Error generating ticket:', error);
                showMessage('خطأ', 'حدث خطأ في توليد التذكرة', 'error');
            } finally {
                isGeneratingTicket = false;
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        function initFirebaseListeners() {
            ticketsListener = db.collection('tickets')
                .orderBy('createdAt', 'desc')
                .limit(100)
                .onSnapshot(snapshot => {
                    tickets = [];
                    snapshot.forEach(doc => {
                        tickets.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateStats();
                    updateRecentTickets();
                    updateAdminStats();
                    updateDepartmentCounters();
                }, error => {
                    console.error('Error listening to tickets:', error);
                });
            
            db.collection('tickets')
                .where('status', '==', 'called')
                .orderBy('updatedAt', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    calledTickets = [];
                    snapshot.forEach(doc => {
                        calledTickets.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateCurrentCall();
                });
            
            Object.values(DEPARTMENTS).forEach(dept => {
                db.collection('counters').doc(dept.id)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            const lastNumber = data.lastNumber || 0;
                            const el = document.querySelector(`.dept-last-number[data-dept="${dept.id}"]`);
                            if (el) el.textContent = lastNumber;
                        }
                    });
            });
            
            realtimeDB.ref('.info/connected').on('value', snapshot => {
                isOnline = snapshot.val();
                updateConnectionStatus();
            });
        }

        // ==================== STATS FUNCTIONS ====================
        function updateStats() {
            const waitingCount = tickets.filter(t => t.status === 'waiting').length;
            const calledCount = tickets.filter(t => t.status === 'called').length;
            const totalCount = tickets.length;
            
            const waitingEl = document.getElementById('waitingCount');
            const calledEl = document.getElementById('calledCount');
            const totalEl = document.getElementById('totalCount');
            
            if (waitingEl) waitingEl.textContent = waitingCount;
            if (calledEl) calledEl.textContent = calledCount;
            if (totalEl) totalEl.textContent = totalCount;
            
            updateDepartmentStats();
        }

        function updateAdminStats() {
            const waiting = tickets.filter(t => t.status === 'waiting').length;
            const called = tickets.filter(t => t.status === 'called').length;
            const completed = tickets.filter(t => t.status === 'completed').length;
            const total = tickets.length;
            
            const waitingEl = document.getElementById('statWaiting');
            const calledEl = document.getElementById('statCalled');
            const completedEl = document.getElementById('statCompleted');
            const totalEl = document.getElementById('statTotal');
            
            if (waitingEl) waitingEl.textContent = waiting;
            if (calledEl) calledEl.textContent = called;
            if (completedEl) completedEl.textContent = completed;
            if (totalEl) totalEl.textContent = total;
        }

        function updateDepartmentStats() {
            Object.values(DEPARTMENTS).forEach(dept => {
                const waitingCount = tickets.filter(t => t.deptId === dept.id && t.status === 'waiting').length;
                const waitingElement = document.querySelector(`.dept-waiting[data-dept="${dept.id}"]`);
                if (waitingElement) {
                    waitingElement.textContent = `${waitingCount} ${LANGUAGES[currentLanguage].waiting}`;
                }
            });
        }

        function updateDepartmentCounters() {
            Object.values(DEPARTMENTS).forEach(dept => {
                const lastTicket = tickets
                    .filter(t => t.deptId === dept.id)
                    .sort((a, b) => parseInt(b.number) - parseInt(a.number))[0];
                
                if (lastTicket) {
                    const el = document.querySelector(`.dept-last-number[data-dept="${dept.id}"]`);
                    if (el) el.textContent = lastTicket.number;
                }
            });
        }

        function updateRecentTickets() {
            recentTickets = tickets.slice(0, 10);
            if (currentScreen === 'display') {
                updateRecentCallsList();
            }
        }

        // ==================== DISPLAY SCREEN FUNCTIONS ====================
        function updateCurrentCall() {
            const currentCallInfo = document.getElementById('currentCallInfo');
            const noCurrentCall = document.getElementById('noCurrentCall');
            const speakingIndicator = document.getElementById('speakingIndicator');
            
            if (!currentCallInfo || !noCurrentCall || !speakingIndicator) return;
            
            if (calledTickets.length > 0) {
                const latestCalled = calledTickets[0];
                const dept = DEPARTMENTS[latestCalled.deptId] || Object.values(DEPARTMENTS)[0];
                
                document.getElementById('displayTicketNumber').textContent = latestCalled.number;
                document.getElementById('displayDeptArabic').textContent = dept.nameAr;
                document.getElementById('displayDeptEnglish').textContent = dept.nameEn;
                document.getElementById('displayRoomArabic').textContent = dept.roomAr;
                document.getElementById('displayRoomEnglish').textContent = dept.roomEn;
                
                currentCallInfo.classList.remove('hidden');
                noCurrentCall.classList.add('hidden');
                speakingIndicator.classList.remove('hidden');
            } else {
                currentCallInfo.classList.add('hidden');
                noCurrentCall.classList.remove('hidden');
                speakingIndicator.classList.add('hidden');
            }
            
            if (currentScreen === 'display') {
                updateRecentCallsList();
            }
        }

        function updateRecentCallsList() {
            const recentCallsList = document.getElementById('recentCallsList');
            if (!recentCallsList) return;
            
            const allRecent = [...calledTickets, ...recentTickets]
                .filter((ticket, index, self) => 
                    index === self.findIndex(t => t.id === ticket.id)
                )
                .slice(0, 10);
            
            if (allRecent.length === 0) {
                recentCallsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-ticket-alt text-3xl mb-3"></i>
                        <p>لا توجد تذاكر حديثة</p>
                    </div>
                `;
                return;
            }
            
            recentCallsList.innerHTML = allRecent.map(ticket => {
                const dept = DEPARTMENTS[ticket.deptId] || Object.values(DEPARTMENTS)[0];
                const isCalled = ticket.status === 'called';
                
                return `
                    <div class="recent-item" style="border-color: ${dept.color}">
                        <div class="flex justify-between items-center">
                            <div class="text-xl font-bold">${ticket.number}</div>
                            <div class="text-sm ${isCalled ? 'text-green-400' : 'text-yellow-400'}">
                                ${isCalled ? 'تم النداء' : 'في الانتظار'}
                            </div>
                        </div>
                        <div class="text-sm mt-1">${dept.nameAr}</div>
                        <div class="text-xs text-gray-400">${dept.roomAr}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== ADMIN DASHBOARD FUNCTIONS ====================
        function handleDepartmentChange() {
            const deptId = document.getElementById('departmentSelect').value;
            selectedDepartment = deptId;
            
            const callNextBtn = document.getElementById('callNextBtn');
            if (callNextBtn) {
                callNextBtn.disabled = !deptId;
            }
            
            updateTicketsDisplay();
        }

        function updateTicketsDisplay() {
            const tableBody = document.getElementById('queueTableBody');
            const emptyMessage = document.getElementById('emptyQueueMessage');
            const queueDeptName = document.getElementById('queueDeptName');
            
            if (!tableBody || !emptyMessage) return;
            
            let filteredTickets = tickets;
            if (selectedDepartment) {
                filteredTickets = tickets.filter(t => t.deptId === selectedDepartment);
                const dept = DEPARTMENTS[selectedDepartment];
                if (dept && queueDeptName) {
                    queueDeptName.textContent = dept.nameAr;
                }
            } else {
                if (queueDeptName) queueDeptName.textContent = 'جميع الأقسام';
            }
            
            if (filteredTickets.length === 0) {
                tableBody.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                return;
            }
            
            emptyMessage.classList.add('hidden');
            
            filteredTickets.sort((a, b) => {
                const statusOrder = { 'called': 0, 'waiting': 1, 'completed': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            tableBody.innerHTML = filteredTickets.map(ticket => {
                const dept = DEPARTMENTS[ticket.deptId] || Object.values(DEPARTMENTS)[0];
                const time = ticket.createdAt ? new Date(ticket.createdAt.toDate()).toLocaleTimeString('ar-EG') : '--:--';
                const statusText = getStatusText(ticket.status);
                const statusClass = getStatusClass(ticket.status);
                
                return `
                    <tr class="${ticket.id === (currentTicket?.id) ? 'bg-blue-50' : ''}">
                        <td class="font-bold text-lg">${ticket.number}</td>
                        <td>${dept.nameAr}</td>
                        <td>${time}</td>
                        <td>
                            <span class="ticket-status ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            ${ticket.status === 'waiting' ? `
                                <button onclick="callTicket('${ticket.id}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                                    نداء
                                </button>
                            ` : ''}
                            ${ticket.status === 'called' ? `
                                <button onclick="completeTicket('${ticket.id}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                    إكمال
                                </button>
                                <button onclick="cancelTicket('${ticket.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 mr-2">
                                    إلغاء
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateCurrentTicketInfo();
        }

        function getStatusText(status) {
            const statusMap = {
                'waiting': 'في الانتظار',
                'called': 'تم النداء',
                'completed': 'مكتملة'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'waiting': 'status-waiting',
                'called': 'status-called',
                'completed': 'status-completed'
            };
            return classMap[status] || 'status-waiting';
        }

        function updateCurrentTicketInfo() {
            const infoElement = document.getElementById('currentTicketInfo');
            const completeBtn = document.getElementById('completeTicketBtn');
            const cancelBtn = document.getElementById('cancelTicketBtn');
            
            if (!infoElement || !completeBtn || !cancelBtn) return;
            
            if (currentTicket) {
                const dept = DEPARTMENTS[currentTicket.deptId] || Object.values(DEPARTMENTS)[0];
                infoElement.innerHTML = `
                    <div class="text-2xl font-bold text-blue-600 mb-1">${currentTicket.number}</div>
                    <div class="text-gray-700">${dept.nameAr}</div>
                    <div class="text-sm text-gray-500">${getStatusText(currentTicket.status)}</div>
                `;
                
                completeBtn.disabled = currentTicket.status !== 'called';
                cancelBtn.disabled = currentTicket.status !== 'called';
            } else {
                infoElement.textContent = 'لا توجد تذكرة مختارة';
                completeBtn.disabled = true;
                cancelBtn.disabled = true;
            }
        }

        async function callNextTicket() {
            if (!selectedDepartment) {
                showMessage('تحذير', 'يرجى اختيار القسم أولاً', 'warning');
                return;
            }
            
            const nextTicket = tickets
                .filter(t => t.deptId === selectedDepartment && t.status === 'waiting')
                .sort((a, b) => parseInt(a.number) - parseInt(b.number))[0];
            
            if (!nextTicket) {
                showMessage('معلومة', 'لا توجد تذاكر في الانتظار لهذا القسم', 'info');
                return;
            }
            
            await callTicket(nextTicket.id);
        }

        async function callTicket(ticketId) {
            try {
                const ticketRef = db.collection('tickets').doc(ticketId);
                await ticketRef.update({
                    status: 'called',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    calledBy: currentUser.username,
                    calledAt: new Date().toISOString()
                });
                
                currentTicket = tickets.find(t => t.id === ticketId);
                if (currentTicket) {
                    currentTicket.status = 'called';
                }
                
                updateCurrentTicketInfo();
                updateTicketsDisplay();
                showTempMessage('تم نداء التذكرة بنجاح', 'success');
            } catch (error) {
                console.error('Error calling ticket:', error);
                showTempMessage('حدث خطأ في نداء التذكرة', 'error');
            }
        }

        async function completeCurrentTicket() {
            if (!currentTicket || currentTicket.status !== 'called') {
                showMessage('تحذير', 'يرجى اختيار تذكرة تم نداؤها', 'warning');
                return;
            }
            
            await completeTicket(currentTicket.id);
        }

        async function completeTicket(ticketId) {
            try {
                const ticketRef = db.collection('tickets').doc(ticketId);
                await ticketRef.update({
                    status: 'completed',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedBy: currentUser.username,
                    completedAt: new Date().toISOString()
                });
                
                currentTicket = null;
                updateCurrentTicketInfo();
                updateTicketsDisplay();
                showTempMessage('تم إكمال التذكرة بنجاح', 'success');
            } catch (error) {
                console.error('Error completing ticket:', error);
                showTempMessage('حدث خطأ في إكمال التذكرة', 'error');
            }
        }

        async function cancelCurrentTicket() {
            if (!currentTicket || currentTicket.status !== 'called') {
                showMessage('تحذير', 'يرجى اختيار تذكرة تم نداؤها', 'warning');
                return;
            }
            
            showConfirm('إلغاء التذكرة', 'هل أنت متأكد من إلغاء هذه التذكرة؟', async () => {
                await cancelTicket(currentTicket.id);
            });
        }

        async function cancelTicket(ticketId) {
            try {
                const ticketRef = db.collection('tickets').doc(ticketId);
                await ticketRef.update({
                    status: 'waiting',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    cancelledBy: currentUser.username,
                    cancelledAt: new Date().toISOString()
                });
                
                currentTicket = null;
                updateCurrentTicketInfo();
                updateTicketsDisplay();
                showTempMessage('تم إلغاء التذكرة بنجاح', 'success');
            } catch (error) {
                console.error('Error cancelling ticket:', error);
                showTempMessage('حدث خطأ في إلغاء التذكرة', 'error');
            }
        }

        async function resetQueue() {
            const message = currentUser.role === 'admin' 
                ? 'هل أنت متأكد من إعادة ضبط جميع التذاكر في النظام؟' 
                : 'هل أنت متأكد من إعادة ضبط تذاكر القسم الحالي؟';
            
            showConfirm('إعادة ضبط الطابور', message, async () => {
                try {
                    if (currentUser.role === 'admin' && !selectedDepartment) {
                        // Reset all tickets
                        const snapshot = await db.collection('tickets').get();
                        const batch = db.batch();
                        
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        
                        // Reset all counters
                        const countersBatch = db.batch();
                        Object.values(DEPARTMENTS).forEach(dept => {
                            const counterRef = db.collection('counters').doc(dept.id);
                            countersBatch.set(counterRef, {
                                lastNumber: 0,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                        
                        await countersBatch.commit();
                    } else {
                        // Reset only selected department
                        const deptId = selectedDepartment || currentUser.dept;
                        
                        // Delete department tickets
                        const snapshot = await db.collection('tickets')
                            .where('deptId', '==', deptId)
                            .get();
                        
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // Reset department counter
                        const counterRef = db.collection('counters').doc(deptId);
                        await counterRef.set({
                            lastNumber: 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    currentTicket = null;
                    updateCurrentTicketInfo();
                    updateTicketsDisplay();
                    showTempMessage('تم إعادة ضبط الطابور بنجاح', 'success');
                } catch (error) {
                    console.error('Error resetting queue:', error);
                    showTempMessage('حدث خطأ في إعادة ضبط الطابور', 'error');
                }
            });
        }

        // ==================== UI FUNCTIONS ====================
        function showSuccessModal(ticketNumber, deptNameAr, deptNameEn) {
            document.getElementById('ticketNumber').textContent = ticketNumber;
            document.getElementById('ticketDept').textContent = 
                `القسم: ${currentLanguage === 'ar' ? deptNameAr : deptNameEn}`;
            document.getElementById('successModal').classList.add('active');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
        }

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            pendingAction = callback;
            document.getElementById('confirmModal').classList.add('active');
        }

        function confirmAction(confirmed) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmed && pendingAction) {
                pendingAction();
            }
            pendingAction = null;
        }

        function showMessage(title, message, type = 'info') {
            const iconMap = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle'
            };
            
            const colorMap = {
                'info': 'text-blue-500',
                'success': 'text-green-500',
                'warning': 'text-yellow-500',
                'error': 'text-red-500'
            };
            
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageIcon').className = `fas ${iconMap[type]} text-5xl ${colorMap[type]}`;
            document.getElementById('messageModal').classList.add('active');
        }

        function closeMessageModal() {
            document.getElementById('messageModal').classList.remove('active');
        }

        function showTempMessage(message, type) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
                color: white;
            `;
            
            messageEl.style.background = type === 'success' ? '#10b981' : '#ef4444';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        document.body.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (isOnline) {
                statusElement.className = 'connection-status connected';
                icon.className = 'fas fa-wifi';
                text.textContent = LANGUAGES[currentLanguage].connected;
            } else {
                statusElement.className = 'connection-status disconnected';
                icon.className = 'fas fa-wifi-slash';
                text.textContent = LANGUAGES[currentLanguage].disconnected;
            }
        }

        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', init);
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
